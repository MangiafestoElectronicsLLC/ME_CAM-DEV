==========================================================
==========================================================

------From Scratch Flash SD Card Via Raspberry Pi Imager

Select Raspberry Pi Zero 2 W Board 

Select custom image to flash and select within files 2023-05-03-raspios-bullseye-armhf-lite.img.xz

After flash 

Set Username and Password
Configure Keyboard and Configure raspi-config to set up wifi

Localization Configure Wi-Fi Country 
advanced setting resize to use full SD card space
Set WIFI
Disable legacy camera
reboot

ssh pc into pi via 

Open Window command terminal bash
  ssh pi@raspberrypi.local

(if .ssh issues remove old host and clear host .txt doc within pc)

From: pi@raspberrypi:~ $

bash: sudo apt update
sudo apt install -y git

cd ~
git clone https://github.com/MangiafestoElectronicsLLC/ME_CAM.git


From: pi@raspberrypi:~/ME_CAM $

sudo apt update && sudo apt full-upgrade -y

 sudo apt install -y \
    python3 python3-pip python3-venv \
    libatlas-base-dev \
    libjpeg-dev libtiff5-dev libjasper-dev libpng-dev \
    libavcodec-dev libavformat-dev libswscale-dev \
    libv4l-dev v4l-utils \
    libgtk2.0-dev \
    libopenblas-dev liblapack-dev \
    git

Still Within: pi@raspberrypi:~/ME_CAM $
Make venv and activate it and then install requirements.txt

python3 -m venv venv
source venv/bin/activate

Within: (venv) pi@raspberrypi:~/ME_CAM $

pip install --upgrade pip
pip install -r requirements.txt

If disconnects try: 
(venv) pi@raspberrypi:~/ME_CAM $ client_loop: send disconnect: Connection reset

ssh pi@raspberrypi.local


cd ~/ME_CAM/ME_CAM-DEV

{If:

(venv) pi@raspberrypi:~/ME_CAM/ME_CAM-DEV $ ls
ai_person_detector.py          main.py
battery_monitor.py             motion_detector.py
camera_pipeline.py             notes.txt
CHANGES.md                     notifications
cloud                          qr_generator.py
config                         QUICKREF.md
config_manager.py              README_FINAL.md
DEPLOYMENT.md                  README.md
docs                           requirements.txt
encryptor.py                   self_update.sh
etc                            setup_mode
face_detector.py               setup.sh
face_recognition_whitelist.py  smart_motion_filter.py
factory_reset.sh               templates
FEATURE_CHECKLIST.md           thumbnail_gen.py
hub_config.json                user_auth.py
hub.py                         utils
IMPLEMENTATION_SUMMARY.md      watchdog.py
libcamera_streamer.py          web
LICENSE                        web_dashboard.py
(venv) pi@raspberrypi:~/ME_CAM/ME_CAM-DEV $ python main.py
Traceback (most recent call last):
  File "/home/pi/ME_CAM/ME_CAM-DEV/main.py", line 1, in <module>
    from loguru import logger
ModuleNotFoundError: No module named 'loguru'

}

Then i Installed Everything on Directory of (venv) pi@raspberrypi:~/ME_CAM $
Instead of (venv) pi@raspberrypi:~/ME_CAM/ME_CAM-DEV $

cd ~/ME_CAM/ME_CAM-DEV

Ensure, VENV is activate should show like (venv) pi@raspberrypi:~/ME_CAM/ME_CAM-DEV $

pip install --upgrade pip
pip install -r requirements.txt

Still Within: (venv) pi@raspberrypi:~/ME_CAM/ME_CAM-DEV $

chmod +x setup.sh
./setup.sh

Should See: === ME Camera Setup (Bullseye) ===

And when Done: 
=== Setup Complete ===
Run ME Camera with:
source venv/bin/activate && python3 main.py

to test: (venv) pi@raspberrypi:~/ME_CAM/ME_CAM-DEV $ python3 main.py


python3 main.py

If Fails Like: 
RuntimeError: module compiled against API version 0xe but this version of numpy is 0xd
Traceback (most recent call last):
  File "/home/pi/ME_CAM/ME_CAM-DEV/main.py", line 2, in <module>
    from web.app import app
  File "/home/pi/ME_CAM/ME_CAM-DEV/web/app.py", line 13, in <module>
    from watchdog import CameraWatchdog
  File "/home/pi/ME_CAM/ME_CAM-DEV/watchdog.py", line 5, in <module>
    from camera_pipeline import CameraPipeline
  File "/home/pi/ME_CAM/ME_CAM-DEV/camera_pipeline.py", line 7, in <module>
    from motion_detector import MotionDetector
  File "/home/pi/ME_CAM/ME_CAM-DEV/motion_detector.py", line 1, in <module>
    import cv2
  File "/home/pi/ME_CAM/venv/lib/python3.9/site-packages/cv2/__init__.py", line 5, in <module>
    from .cv2 import *
ImportError: numpy.core.multiarray failed to import

Try:
pip install --upgrade numpy

pip install --upgrade numpy
pip uninstall opencv-python opencv-python-headless opencv-contrib-python -y
pip install opencv-python-headless

Retry By:
python3 main.py

If Disconnects again try:

ssh pi@raspberrypi.local

cd ~/ME_CAM/ME_CAM-DEV

source venv/bin/activate

python3 main.py

Now QR Code is found @  http://10.2.1.47:8080
After Basic Setup and config
Create Account and login (Will Likely need to reboot and run again)

(Control + C to exit the working code and bash below commands)
Sudo Reboot



ME CAMERA ‚Äì PI ZERO 2 W COMPLETE SETUP GUIDE
============================================

This guide walks from a blank SD card ‚Üí fully running ME Camera with auto-boot.
Now to improve the GitHub project: https://github.com/MangiafestoElectronicsLLC/ME_CAM-DEV
--------------------------------------------
0. Prequal
--------------------------------------------
From Scratch Flash SD Card Via Raspberry Pi Imager
Select Raspberry Pi Zero 2 W Board 

Select custom image to flash and select within files 2023-05-03-raspios-bullseye-armhf-lite.img.xz

After flash 

Set Username and Password
Configure Keyboard and Configure raspi-config to set up wifi
Localization Configure Wi-Fi Country 
advanced setting resize to use full SD card space
Set WIFI
Disable legacy camera
reboot

--------------------------------------------
1. FLASH RASPBERRY PI OS (LEGACY) BULLSEYE
--------------------------------------------
Use Raspberry Pi Imager:

Choose OS ‚Üí
  Raspberry Pi OS (Other) ‚Üí
    Raspberry Pi OS (Legacy) ‚Üí
      Raspberry Pi OS Lite (Legacy)

Enable:
- SSH
- Wi-Fi
- Username/password

Flash SD card and boot Pi.

--------------------------------------------
2. CONNECT TO THE PI
--------------------------------------------
ssh pi@raspberrypi.local

--------------------------------------------
3. CLEAN ANY OLD INSTALLS
--------------------------------------------
sudo systemctl stop mecamera 2>/dev/null
sudo systemctl disable mecamera 2>/dev/null
sudo rm -f /etc/systemd/system/mecamera.service
sudo systemctl daemon-reload

rm -rf ~/ME_CAM
rm -rf ~/.cache/pip
sudo apt autoremove -y
sudo apt clean

--------------------------------------------
4. CLONE THE ME_CAMERA REPOSITORY 
--------------------------------------------
Working for DEV @ https://github.com/MangiafestoElectronicsLLC/ME_CAM-DEV

cd ~
git clone https://github.com/MangiafestoElectronicsLLC/ME_CAM-DEV.git
cd ME_CAM-DEV
git branch -a
--------------------------------------------
5. CREATE VIRTUAL ENVIRONMENT
--------------------------------------------
python3 -m venv venv
source venv/bin/activate

You should see: (venv) pi@raspberrypi:~/ME_CAM-DEV $

--------------------------------------------
6. INSTALL DEPENDENCIES
--------------------------------------------
pip install --upgrade pip
pip install -r requirements.txt

(This will take 5-10 minutes on Pi Zero 2 W)

If OpenCV fails with "numpy.core.multiarray" error, run:
pip install --upgrade numpy
pip uninstall opencv-python opencv-python-headless opencv-contrib-python -y
pip install opencv-python-headless

If you see "NumPy 2.0.2" or "NumPy 1.x cannot be run in NumPy 2.0" error:
pip install "numpy<2"

--------------------------------------------
7. RUN THE AUTOMATED SETUP SCRIPT
--------------------------------------------
chmod +x setup.sh
./setup.sh

This script:
- Creates config directories
- Copies default configuration
- Sets file permissions
- Prepares storage paths

You should see: === Setup Complete ===

--------------------------------------------
8. RUN ME CAMERA (FIRST TIME)
--------------------------------------------
python3 main.py

Open in browser:
http://raspberrypi.local:8080

You will see the FIRST RUN SETUP WIZARD.

‚úì Dashboard Working:
- System Status shows "Active" and "Pipeline running"
- Live Camera feed displays (slower on Pi Zero 2 W - ~1-2 FPS is normal)
- Storage shows 0.0 GB initially (displays used space once recordings start)
- Battery status shows power source
- System monitors motion detection in background

--------------------------------------------
9. ENABLE AUTO-BOOT ON STARTUP
--------------------------------------------
After the first manual run is successful, enable auto-boot so ME_CAM starts
automatically whenever the Pi boots up (no SSH or manual start needed).

IMPORTANT: Pull the latest code first to get the corrected service file!

On your Pi, run:

git pull origin main
sudo cp etc/systemd/system/mecamera.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable mecamera
sudo systemctl start mecamera

Verify it's running:
sudo systemctl status mecamera

View logs in real-time:
sudo journalctl -u mecamera.service -f

From now on, the system will:
- Start ME_CAM automatically on Pi boot
- Restart the service if it crashes
- Be accessible at http://raspberrypi.local:8080

To disable auto-boot (if needed):
sudo systemctl disable mecamera

To manually stop the service:
sudo systemctl stop mecamera

To manually restart the service:
sudo systemctl restart mecamera

--------------------------------------------
10. TROUBLESHOOTING
--------------------------------------------

NumPy/OpenCV compatibility error:
If you see: "numpy.core.multiarray failed to import" or "_ARRAY_API not found"
Run: pip install "numpy<2"
Then: pip uninstall opencv-python opencv-python-headless opencv-contrib-python -y
Finally: pip install opencv-python-headless
Retry: python3 main.py

(Note: Pi Zero 2 W ships with NumPy 2.x by default, which is incompatible with precompiled OpenCV)

Camera shows "no cameras available":
- Ensure legacy camera is disabled in raspi-config
- Run: libcamera-still --list-cameras
- If no cameras: reboot Pi

SSH disconnects during install:
- ssh pi@raspberrypi.local
- cd ~/ME_CAM-DEV
- source venv/bin/activate
- Continue from where you left off

Python import errors:
- Make sure venv is activated: (venv) should show in prompt
- If missing modules: pip install -r requirements.txt
- Check venv is in correct directory: pwd should show ~/ME_CAM-DEV

Template rendering errors:
- These have been fixed in the latest code
- git pull origin main to get latest fixes

Camera/Video performance:
- Live feed is ~1-2 FPS on Pi Zero 2 W (normal for libcamera-still)
- This is reliable but slower than traditional streaming
- Storage displays 0.0 GB until first recording is captured
- Once motion is detected, recordings will appear in storage
Motion detection not recording:
- Motion detection service now runs automatically on app startup
- Verify motion_service is running: check dashboard shows "Pipeline running"
- Motion events will save to ~/recordings/ directory
- Storage section updates automatically (may take 5 seconds)
- Check logs: tail -f ~/ME_CAM-DEV/logs/mecam.log | grep MOTION
- Ensure motion detection enabled during first-run setup

Storage display not showing used/available space:
- Dashboard now fetches real-time storage via /api/storage endpoint
- Storage info refreshes every time you load /dashboard
- Recordings directory: ~/ME_CAM-DEV/recordings
- Try refreshing browser or check browser console for API errors
- Available/Total/Used/Files displayed in real-time

Battery/Power measurement improvements:
- Battery percent now defaults to 100% when external power detected
- Dashboard shows "External Power" when plugged in
- For actual battery monitoring, hardware HAT with ADC required
- To manually set battery level: edit config.json "battery_percent_override"
- System detects undervoltage via vcgencmd (automatic)

Dashboard Features:
- "Send Last Clip to First Responders": Uploads to Google Drive + emails (if enabled)
- Storage summary: Used/Available/Total/File count displayed in real-time
- Motion recordings saved automatically when motion detected
- Live camera feed: ~1-2 FPS MJPEG stream (normal for Pi Zero 2W)
--------------------------------------------
Dashboard ‚Üí ‚ÄúSend Last Clip to First Responders‚Äù

This:
- Uploads clip to Google Drive (if enabled)
- Emails clip + link (if enabled)

--------------------------------------------
9. FACTORY RESET
--------------------------------------------
./factory_reset.sh

This wipes:
- config.json
- recordings
- exports

--------------------------------------------
12. SELF UPDATE
--------------------------------------------
./self_update.sh

Pulls latest DEV branch, reinstalls dependencies, restarts service.

====================================================
RECENT FIXES & IMPROVEMENTS (Session: Jan 13, 2026)
====================================================

‚úÖ MOTION DETECTION NOW WORKING
- Motion detection service enabled and auto-starts on app boot
- Motion events save 30-second clips to ~/ME_CAM-DEV/recordings/
- Service runs in background thread without blocking camera streaming
- Checks for motion every 2 seconds
- Starts recording when motion detected, stops after 5 seconds of no motion
- Logs all motion events with [MOTION] prefix in logs/mecam.log

‚úÖ STORAGE DISPLAY FIXED
- Dashboard now shows real-time storage usage (Used/Available/Total/Files)
- Fetches via /api/storage endpoint every page load
- Displays storage bar with usage percentage
- Recordings show size, date, and download/delete options
- "Clear All Recordings" button to wipe all videos

‚úÖ POWER SUPPLY MEASUREMENT IMPROVED
- Battery percent now defaults to 100% when external power detected
- Dashboard shows "External Power" label when plugged in
- Detects undervoltage via vcgencmd automatically
- For actual battery monitoring, hardware HAT with ADC required
- Can manually override battery % in config.json: "battery_percent_override": 80

‚úÖ VIDEO STREAMING OPTIMIZED
- Already set to 2 FPS (0.5 second frame delay) on Pi Zero 2 W
- This is the optimal speed for the  hardware
- Uses libcamera-still with -t 100 (100ms timeout) and --immediate flag
- Reliable MJPEG stream to web dashboard

‚úÖ FIRST-BOOT AUTO-SETUP ENABLED
- Motion detection starts automatically after first-run setup completed
- Dashboard ensures motion service running on every page load
- If disabled, service still starts (can configure later in settings)
- User guided through setup wizard on first access

====================================================
CODE CHANGES MADE
====================================================

main.py:
- Added motion_service import
- Motion service starts on app startup
- Logging confirms service initiated

web/app.py:
- Enabled motion_service import (was disabled)
- Dashboard ensures motion service running
- Better battery percentage defaults (100% on external power)
- Fixed status.active to True (no watchdog dependency)
- First-run setup now starts motion service after completion

config_manager.py:
- Added _merge_configs() function
- Merges user config with defaults (adds missing keys)
- Fixes issues when recordings_dir missing from config.json
- Prevents KeyError exceptions when old configs lack new fields

libcamera_motion_detector.py:
- Fixed subprocess call: removed invalid capture_output + stderr combo
- Now uses stdout=DEVNULL, stderr=DEVNULL correctly
- Timeout set to 2 seconds for frame capture
- Motion detection runs every 2 seconds in background

web/templates/user_dashboard.html:
- Improved camera feed display with proper aspect ratio
- Fixed MJPEG stream display (img src=/api/stream works)

etc/systemd/system/mecamera.service:
- Paths corrected to /ME_CAM-DEV
- Added Type=simple and RestartSec=10
- Service auto-restarts on failure

====================================================
WHAT TO EXPECT NOW
====================================================

When you boot your Pi:
1. Systemd service starts mecamera automatically
2. Flask app launches on port 8080
3. Motion detection service initializes in background
4. Access at http://raspberrypi.local:8080
5. Dashboard shows live camera + storage info

When motion is detected:
- 30-second video clip recorded to ~/recordings/
- File named motion_YYYYMMDD_HHMMSS.mp4
- Dashboard updates with new recording
- Storage section increments file count and used space

Storage display updates:
- Real-time via /api/storage endpoint
- Shows Used GB, Available GB, Total GB, File Count
- Progress bar shows usage percentage
- Refresh page to see latest values

Known limitations:
- Motion detection sometimes times out because camera busy with streaming
- This is normal - service retries automatically every 2 seconds
- For pure motion recording (no streaming), improve performance significantly
- Can configure motion_only=false to stream always

====================================================
11. READY FOR MAIN BRANCH
--------------------------------------------
Once tested:
git checkout main
git merge DEV
git push origin main

--------------------------------------------
ADDED NOTES
--------------------------------------------
Update system:
sudo apt update && sudo apt full-upgrade -y
sudo reboot

2. Install System Dependencies
Your project uses OpenCV, TensorFlow Lite, Flask, and camera stack components.
Install everything required:
sudo apt install -y \
    python3 python3-pip python3-venv \
    libatlas-base-dev \
    libjpeg-dev libtiff5-dev libjasper-dev libpng-dev \
    libavcodec-dev libavformat-dev libswscale-dev \
    libv4l-dev v4l-utils \
    libgtk2.0-dev \
    libopenblas-dev liblapack-dev \
    git

Clone the DEV Branch
cd ~
git clone -b DEV https://github.com/MangiafestoElectronicsLLC/ME_CAM.git
cd ME_CAM


4. Create Virtual Environment
Your repo expects Python 3.9 (Bullseye ships with 3.9)

python3 -m venv venv
source venv/bin/activate


5. Install Python Dependencies
Your requirements.txt includes OpenCV, Flask, TFLite runtime, etc. Install them:

pip install --upgrade pip
pip install -r requirements.txt

If TensorFlow Lite fails (common on Pi Zero), install the correct wheel:

pip install https://github.com/google-coral/pycoral/releases/download/release-frogfish/tflite_runtime-2.7.0-cp39-cp39-linux_armv7l.whl

6. Run the Setup Script
Your repo includes a setup.sh script for first‚Äërun configuration.



Make it executable: From (venv) pi@raspberrypi:~/ME_CAM/ME_CAM-DEV $ 
chmod +x setup.sh
./setup.sh

This script:

Creates config directories

Copies default config

Prepares storage paths

Sets permissions

‚ñ∂Ô∏è 7. Test the Camera Pipeline
Run the main program manually:

python3 main.py

You should see logs from:

camera_pipeline.py

motion_detector.py

ai_person_detector.py

web_dashboard.py

If the dashboard loads, visit:

Code
http://<pi-ip>:5000
üîÅ 8. Install the Systemd Service
Your repo includes a service file at:

Code
etc/systemd/system/mecamera.service

Install it:

bash
sudo cp etc/systemd/system/mecamera.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable mecamera.service
sudo systemctl start mecamera.service
Check logs:

bash
sudo journalctl -u mecamera.service -f
üîê Optional: WireGuard Setup
Your repo includes a full guide at:
docs/wireguard_setup.md

üéâ Deployment Complete
At this point:

The camera boots automatically

The dashboard is available on port 5000

Motion/person detection runs continuously

Clips are stored + encrypted (if enabled)

Notifications (email/GDrive) work once configured

ssh pi@raspberrypi.local

pi@raspberrypi:~ $ cd ME_CAM
pi@raspberrypi:~/ME_CAM $ source venv/bin/activate
(venv) pi@raspberrypi:~/ME_CAM $ chmod +x setup.sh
./setup.sh


ssh pi@raspberrypi.local (Re-entry into pi from PC)

cd ~/ME_CAM/ME_CAM-DEV   (Change to correct directory)
cd ~/ME_CAM-DEV
source venv/bin/activate    (Activate VENV)

python3 main.py       (RUN APP)

--------------------------------------------
END OF NOTES
--------------------------------------------
