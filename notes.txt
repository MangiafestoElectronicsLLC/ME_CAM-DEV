==========================================================
==========================================================

------From Scratch Flash SD Card Via Raspberry Pi Imager

Select Raspberry Pi Zero 2 W Board 

Select custom image to flash and select within files 2023-05-03-raspios-bullseye-armhf-lite.img.xz

After flash 

Set Username and Password
Configure Keyboard and Configure raspi-config to set up wifi

Localization Configure Wi-Fi Country 
advanced setting resize to use full SD card space
Set WIFI
Disable legacy camera
reboot

ssh pc into pi via 

Open Window command terminal bash
  ssh pi@raspberrypi.local

(if .ssh issues remove old host and clear host .txt doc within pc)

From: pi@raspberrypi:~ $

bash: sudo apt update
sudo apt install -y git

cd ~
git clone https://github.com/MangiafestoElectronicsLLC/ME_CAM.git


From: pi@raspberrypi:~/ME_CAM $

sudo apt update && sudo apt full-upgrade -y

 sudo apt install -y \
    python3 python3-pip python3-venv \
    libatlas-base-dev \
    libjpeg-dev libtiff5-dev libjasper-dev libpng-dev \
    libavcodec-dev libavformat-dev libswscale-dev \
    libv4l-dev v4l-utils \
    libgtk2.0-dev \
    libopenblas-dev liblapack-dev \
    git

Still Within: pi@raspberrypi:~/ME_CAM $
Make venv and activate it and then install requirements.txt

python3 -m venv venv
source venv/bin/activate

Within: (venv) pi@raspberrypi:~/ME_CAM $

pip install --upgrade pip
pip install -r requirements.txt

If disconnects try: 
(venv) pi@raspberrypi:~/ME_CAM $ client_loop: send disconnect: Connection reset

ssh pi@raspberrypi.local


cd ~/ME_CAM/ME_CAM-DEV

{If:

(venv) pi@raspberrypi:~/ME_CAM/ME_CAM-DEV $ ls
ai_person_detector.py          main.py
battery_monitor.py             motion_detector.py
camera_pipeline.py             notes.txt
CHANGES.md                     notifications
cloud                          qr_generator.py
config                         QUICKREF.md
config_manager.py              README_FINAL.md
DEPLOYMENT.md                  README.md
docs                           requirements.txt
encryptor.py                   self_update.sh
etc                            setup_mode
face_detector.py               setup.sh
face_recognition_whitelist.py  smart_motion_filter.py
factory_reset.sh               templates
FEATURE_CHECKLIST.md           thumbnail_gen.py
hub_config.json                user_auth.py
hub.py                         utils
IMPLEMENTATION_SUMMARY.md      watchdog.py
libcamera_streamer.py          web
LICENSE                        web_dashboard.py
(venv) pi@raspberrypi:~/ME_CAM/ME_CAM-DEV $ python main.py
Traceback (most recent call last):
  File "/home/pi/ME_CAM/ME_CAM-DEV/main.py", line 1, in <module>
    from loguru import logger
ModuleNotFoundError: No module named 'loguru'

}

Then i Installed Everything on Directory of (venv) pi@raspberrypi:~/ME_CAM $
Instead of (venv) pi@raspberrypi:~/ME_CAM/ME_CAM-DEV $

cd ~/ME_CAM/ME_CAM-DEV

Ensure, VENV is activate should show like (venv) pi@raspberrypi:~/ME_CAM/ME_CAM-DEV $

pip install --upgrade pip
pip install -r requirements.txt

Still Within: (venv) pi@raspberrypi:~/ME_CAM/ME_CAM-DEV $

chmod +x setup.sh
./setup.sh

Should See: === ME Camera Setup (Bullseye) ===

And when Done: 
=== Setup Complete ===
Run ME Camera with:
source venv/bin/activate && python3 main.py

to test: (venv) pi@raspberrypi:~/ME_CAM/ME_CAM-DEV $ python3 main.py


python3 main.py

If Fails Like: 
RuntimeError: module compiled against API version 0xe but this version of numpy is 0xd
Traceback (most recent call last):
  File "/home/pi/ME_CAM/ME_CAM-DEV/main.py", line 2, in <module>
    from web.app import app
  File "/home/pi/ME_CAM/ME_CAM-DEV/web/app.py", line 13, in <module>
    from watchdog import CameraWatchdog
  File "/home/pi/ME_CAM/ME_CAM-DEV/watchdog.py", line 5, in <module>
    from camera_pipeline import CameraPipeline
  File "/home/pi/ME_CAM/ME_CAM-DEV/camera_pipeline.py", line 7, in <module>
    from motion_detector import MotionDetector
  File "/home/pi/ME_CAM/ME_CAM-DEV/motion_detector.py", line 1, in <module>
    import cv2
  File "/home/pi/ME_CAM/venv/lib/python3.9/site-packages/cv2/__init__.py", line 5, in <module>
    from .cv2 import *
ImportError: numpy.core.multiarray failed to import

Try:
pip install --upgrade numpy

pip install --upgrade numpy
pip uninstall opencv-python opencv-python-headless opencv-contrib-python -y
pip install opencv-python-headless

Retry By:
python3 main.py

If Disconnects again try:

ssh pi@raspberrypi.local

cd ~/ME_CAM/ME_CAM-DEV

source venv/bin/activate

python3 main.py

Now QR Code is found @  http://10.2.1.47:8080
After Basic Setup and config
Create Account and login (Will Likely need to reboot and run again)

(Control + C to exit the working code and bash below commands)
Sudo Reboot



ME CAMERA ‚Äì PI ZERO 2 W COMPLETE SETUP GUIDE
============================================

This guide walks from a blank SD card ‚Üí fully running ME Camera with auto-boot.
Now to improve the GitHub project: https://github.com/MangiafestoElectronicsLLC/ME_CAM-DEV
--------------------------------------------
0. Prequal
--------------------------------------------
From Scratch Flash SD Card Via Raspberry Pi Imager
Select Raspberry Pi Zero 2 W Board 

Select custom image to flash and select within files 2023-05-03-raspios-bullseye-armhf-lite.img.xz

After flash 

Set Username and Password
Configure Keyboard and Configure raspi-config to set up wifi
Localization Configure Wi-Fi Country 
advanced setting resize to use full SD card space
Set WIFI
Disable legacy camera
reboot

--------------------------------------------
1. FLASH RASPBERRY PI OS (LEGACY) BULLSEYE
--------------------------------------------
Use Raspberry Pi Imager:

Choose OS ‚Üí
  Raspberry Pi OS (Other) ‚Üí
    Raspberry Pi OS (Legacy) ‚Üí
      Raspberry Pi OS Lite (Legacy)

Enable:
- SSH
- Wi-Fi
- Username/password

Flash SD card and boot Pi.

--------------------------------------------
2. CONNECT TO THE PI
--------------------------------------------
ssh pi@raspberrypi.local

--------------------------------------------
3. CLEAN ANY OLD INSTALLS
--------------------------------------------
sudo systemctl stop mecamera 2>/dev/null
sudo systemctl disable mecamera 2>/dev/null
sudo rm -f /etc/systemd/system/mecamera.service
sudo systemctl daemon-reload

rm -rf ~/ME_CAM
rm -rf ~/.cache/pip
sudo apt autoremove -y
sudo apt clean

--------------------------------------------
4. CLONE THE ME_CAMERA REPOSITORY 
--------------------------------------------
Working for DEV @ https://github.com/MangiafestoElectronicsLLC/ME_CAM-DEV

cd ~
git clone https://github.com/MangiafestoElectronicsLLC/ME_CAM-DEV.git
cd ME_CAM-DEV
git branch -a
--------------------------------------------
5. CREATE VIRTUAL ENVIRONMENT
--------------------------------------------
python3 -m venv venv
source venv/bin/activate

You should see: (venv) pi@raspberrypi:~/ME_CAM-DEV $

--------------------------------------------
6. INSTALL DEPENDENCIES
--------------------------------------------
pip install --upgrade pip
pip install -r requirements.txt

(This will take 5-10 minutes on Pi Zero 2 W)

If OpenCV fails with "numpy.core.multiarray" error, run:
pip install --upgrade numpy
pip uninstall opencv-python opencv-python-headless opencv-contrib-python -y
pip install opencv-python-headless

If you see "NumPy 2.0.2" or "NumPy 1.x cannot be run in NumPy 2.0" error:
pip install "numpy<2"

--------------------------------------------
7. RUN THE AUTOMATED SETUP SCRIPT
--------------------------------------------
chmod +x setup.sh
./setup.sh

This script:
- Creates config directories
- Copies default configuration
- Sets file permissions
- Prepares storage paths

You should see: === Setup Complete ===

--------------------------------------------
8. RUN ME CAMERA (FIRST TIME)
--------------------------------------------
python3 main.py

Open in browser:
http://raspberrypi.local:8080

You will see the FIRST RUN SETUP WIZARD.

‚úì Dashboard Working:
- System Status shows "Active" and "Pipeline running"
- Live Camera feed displays (slower on Pi Zero 2 W - ~1-2 FPS is normal)
- Storage shows 0.0 GB initially (displays used space once recordings start)
- Battery status shows power source
- System monitors motion detection in background

--------------------------------------------
9. ENABLE AUTO-BOOT ON STARTUP
--------------------------------------------
After the first manual run is successful, enable auto-boot so ME_CAM starts
automatically whenever the Pi boots up (no SSH or manual start needed).

IMPORTANT: Pull the latest code first to get the corrected service file!

On your Pi, run:

git pull origin main
sudo cp etc/systemd/system/mecamera.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable mecamera
sudo systemctl start mecamera

Verify it's running:
sudo systemctl status mecamera

View logs in real-time:
sudo journalctl -u mecamera.service -f

From now on, the system will:
- Start ME_CAM automatically on Pi boot
- Restart the service if it crashes
- Be accessible at http://raspberrypi.local:8080

To disable auto-boot (if needed):
sudo systemctl disable mecamera

To manually stop the service:
sudo systemctl stop mecamera

To manually restart the service:
sudo systemctl restart mecamera

--------------------------------------------
10. TROUBLESHOOTING
--------------------------------------------

NumPy/OpenCV compatibility error:
If you see: "numpy.core.multiarray failed to import" or "_ARRAY_API not found"
Run: pip install "numpy<2"
Then: pip uninstall opencv-python opencv-python-headless opencv-contrib-python -y
Finally: pip install opencv-python-headless
Retry: python3 main.py

(Note: Pi Zero 2 W ships with NumPy 2.x by default, which is incompatible with precompiled OpenCV)

Camera shows "no cameras available":
- Ensure legacy camera is disabled in raspi-config
- Run: libcamera-still --list-cameras
- If no cameras: reboot Pi

SSH disconnects during install:
- ssh pi@raspberrypi.local
- cd ~/ME_CAM-DEV
- source venv/bin/activate
- Continue from where you left off

Python import errors:
- Make sure venv is activated: (venv) should show in prompt
- If missing modules: pip install -r requirements.txt
- Check venv is in correct directory: pwd should show ~/ME_CAM-DEV

Template rendering errors:
- These have been fixed in the latest code
- git pull origin main to get latest fixes

Camera/Video performance:
- Live feed is ~1-2 FPS on Pi Zero 2 W (normal for libcamera-still)
- This is reliable but slower than traditional streaming
- Storage displays 0.0 GB until first recording is captured
- Once motion is detected, recordings will appear in storage
Motion detection not recording:
- Motion detection service now runs automatically on app startup
- Verify motion_service is running: check dashboard shows "Pipeline running"
- Motion events will save to ~/recordings/ directory
- Storage section updates automatically (may take 5 seconds)
- Check logs: tail -f ~/ME_CAM-DEV/logs/mecam.log | grep MOTION
- Ensure motion detection enabled during first-run setup

Storage display not showing used/available space:
- Dashboard now fetches real-time storage via /api/storage endpoint
- Storage info refreshes every time you load /dashboard
- Recordings directory: ~/ME_CAM-DEV/recordings
- Try refreshing browser or check browser console for API errors
- Available/Total/Used/Files displayed in real-time

Battery/Power measurement improvements:
- Battery percent now defaults to 100% when external power detected
- Dashboard shows "External Power" when plugged in
- For actual battery monitoring, hardware HAT with ADC required
- To manually set battery level: edit config.json "battery_percent_override"
- System detects undervoltage via vcgencmd (automatic)

Dashboard Features:
- "Send Last Clip to First Responders": Uploads to Google Drive + emails (if enabled)
- Storage summary: Used/Available/Total/File count displayed in real-time
- Motion recordings saved automatically when motion detected
- Live camera feed: ~1-2 FPS MJPEG stream (normal for Pi Zero 2W)
--------------------------------------------
Dashboard ‚Üí ‚ÄúSend Last Clip to First Responders‚Äù

This:
- Uploads clip to Google Drive (if enabled)
- Emails clip + link (if enabled)

--------------------------------------------
9. FACTORY RESET
--------------------------------------------
./factory_reset.sh

This wipes:
- config.json
- recordings
- exports

--------------------------------------------
12. SELF UPDATE
--------------------------------------------
./self_update.sh

Pulls latest DEV branch, reinstalls dependencies, restarts service.

====================================================
RECENT FIXES & IMPROVEMENTS (Session: Jan 13, 2026)
====================================================

‚úÖ MOTION DETECTION NOW WORKING
- Motion detection service enabled and auto-starts on app boot
- Motion events save 30-second clips to ~/ME_CAM-DEV/recordings/
- Service runs in background thread without blocking camera streaming
- Checks for motion every 2 seconds
- Starts recording when motion detected, stops after 5 seconds of no motion
- Logs all motion events with [MOTION] prefix in logs/mecam.log

‚úÖ STORAGE DISPLAY FIXED
- Dashboard now shows real-time storage usage (Used/Available/Total/Files)
- Fetches via /api/storage endpoint every page load
- Displays storage bar with usage percentage
- Recordings show size, date, and download/delete options
- "Clear All Recordings" button to wipe all videos

‚úÖ POWER SUPPLY MEASUREMENT IMPROVED
- Battery percent now defaults to 100% when external power detected
- Dashboard shows "External Power" label when plugged in
- Detects undervoltage via vcgencmd automatically
- For actual battery monitoring, hardware HAT with ADC required
- Can manually override battery % in config.json: "battery_percent_override": 80

‚úÖ VIDEO STREAMING OPTIMIZED
- Already set to 2 FPS (0.5 second frame delay) on Pi Zero 2 W
- This is the optimal speed for the  hardware
- Uses libcamera-still with -t 100 (100ms timeout) and --immediate flag
- Reliable MJPEG stream to web dashboard

‚úÖ FIRST-BOOT AUTO-SETUP ENABLED
- Motion detection starts automatically after first-run setup completed
- Dashboard ensures motion service running on every page load
- If disabled, service still starts (can configure later in settings)
- User guided through setup wizard on first access

====================================================
CODE CHANGES MADE
====================================================

main.py:
- Added motion_service import
- Motion service starts on app startup
- Logging confirms service initiated

web/app.py:
- Enabled motion_service import (was disabled)
- Dashboard ensures motion service running
- Better battery percentage defaults (100% on external power)
- Fixed status.active to True (no watchdog dependency)
- First-run setup now starts motion service after completion

config_manager.py:
- Added _merge_configs() function
- Merges user config with defaults (adds missing keys)
- Fixes issues when recordings_dir missing from config.json
- Prevents KeyError exceptions when old configs lack new fields

libcamera_motion_detector.py:
- Fixed subprocess call: removed invalid capture_output + stderr combo
- Now uses stdout=DEVNULL, stderr=DEVNULL correctly
- Timeout set to 2 seconds for frame capture
- Motion detection runs every 2 seconds in background

web/templates/user_dashboard.html:
- Improved camera feed display with proper aspect ratio
- Fixed MJPEG stream display (img src=/api/stream works)

etc/systemd/system/mecamera.service:
- Paths corrected to /ME_CAM-DEV
- Added Type=simple and RestartSec=10
- Service auto-restarts on failure

====================================================
WHAT TO EXPECT NOW
====================================================

When you boot your Pi:
1. Systemd service starts mecamera automatically
2. Flask app launches on port 8080
3. Motion detection service initializes in background
4. Access at http://raspberrypi.local:8080
5. Dashboard shows live camera + storage info

When motion is detected:
- 30-second video clip recorded to ~/recordings/
- File named motion_YYYYMMDD_HHMMSS.mp4
- Dashboard updates with new recording
- Storage section increments file count and used space

Storage display updates:
- Real-time via /api/storage endpoint
- Shows Used GB, Available GB, Total GB, File Count
- Progress bar shows usage percentage
- Refresh page to see latest values

Known limitations:
- Motion detection sometimes times out because camera busy with streaming
- This is normal - service retries automatically every 2 seconds
- For pure motion recording (no streaming), improve performance significantly
- Can configure motion_only=false to stream always

====================================================
11. READY FOR MAIN BRANCH
--------------------------------------------
Once tested:
git checkout main
git merge DEV
git push origin main

--------------------------------------------
ADDED NOTES
--------------------------------------------
Update system:
sudo apt update && sudo apt full-upgrade -y
sudo reboot

2. Install System Dependencies
Your project uses OpenCV, TensorFlow Lite, Flask, and camera stack components.
Install everything required:
sudo apt install -y \
    python3 python3-pip python3-venv \
    libatlas-base-dev \
    libjpeg-dev libtiff5-dev libjasper-dev libpng-dev \
    libavcodec-dev libavformat-dev libswscale-dev \
    libv4l-dev v4l-utils \
    libgtk2.0-dev \
    libopenblas-dev liblapack-dev \
    git

Clone the DEV Branch
cd ~
git clone -b DEV https://github.com/MangiafestoElectronicsLLC/ME_CAM.git
cd ME_CAM


4. Create Virtual Environment
Your repo expects Python 3.9 (Bullseye ships with 3.9)

python3 -m venv venv
source venv/bin/activate


5. Install Python Dependencies
Your requirements.txt includes OpenCV, Flask, TFLite runtime, etc. Install them:

pip install --upgrade pip
pip install -r requirements.txt

If TensorFlow Lite fails (common on Pi Zero), install the correct wheel:

pip install https://github.com/google-coral/pycoral/releases/download/release-frogfish/tflite_runtime-2.7.0-cp39-cp39-linux_armv7l.whl

6. Run the Setup Script
Your repo includes a setup.sh script for first‚Äërun configuration.



Make it executable: From (venv) pi@raspberrypi:~/ME_CAM/ME_CAM-DEV $ 
chmod +x setup.sh
./setup.sh

This script:

Creates config directories

Copies default config

Prepares storage paths

Sets permissions

‚ñ∂Ô∏è 7. Test the Camera Pipeline
Run the main program manually:

python3 main.py

You should see logs from:

camera_pipeline.py

motion_detector.py

ai_person_detector.py

web_dashboard.py

If the dashboard loads, visit:

Code
http://<pi-ip>:5000
üîÅ 8. Install the Systemd Service
Your repo includes a service file at:

Code
etc/systemd/system/mecamera.service

Install it:

bash
sudo cp etc/systemd/system/mecamera.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable mecamera.service
sudo systemctl start mecamera.service
Check logs:

bash
sudo journalctl -u mecamera.service -f
üîê Optional: WireGuard Setup
Your repo includes a full guide at:
docs/wireguard_setup.md

üéâ Deployment Complete
At this point:

The camera boots automatically

The dashboard is available on port 5000

Motion/person detection runs continuously

Clips are stored + encrypted (if enabled)

Notifications (email/GDrive) work once configured

ssh pi@raspberrypi.local

pi@raspberrypi:~ $ cd ME_CAM
pi@raspberrypi:~/ME_CAM $ source venv/bin/activate
(venv) pi@raspberrypi:~/ME_CAM $ chmod +x setup.sh
./setup.sh


ssh pi@raspberrypi.local (Re-entry into pi from PC)

cd ~/ME_CAM/ME_CAM-DEV   (Change to correct directory)
cd ~/ME_CAM-DEV
source venv/bin/activate    (Activate VENV)

python3 main.py       (RUN APP)

--------------------------------------------
END OF ORIGINAL NOTES
--------------------------------------------


============================================
üö® EMERGENCY FEATURES & RECORDING SETUP
============================================

## üéØ QUICK SETUP STEPS

### 1. Deploy New Features to Pi
```bash
ssh pi@raspberrypi.local
cd ~/ME_CAM-DEV
git pull origin main
sudo systemctl restart mecamera
sudo systemctl status mecamera
```

### 2. Configure Emergency Contacts (in Web Dashboard)
1. Open: http://raspberrypi.local:8080
2. Login ‚Üí Click "‚öôÔ∏è Configure"
3. Scroll to "üö® Emergency Contacts" (red section)
4. Fill in:
   - Device Location: "Living Room", "Bedroom", etc.
   - Primary Contact: Wife's phone SMS gateway
   - Owner Email: Your email
   - Emergency Mode: Medical/Security/Both

### 3. SMS to Wife's Phone Setup
**Carrier Email Gateways:**
- Verizon: `5852274686@vtext.com`
- AT&T: `5852274686@txt.att.net`
- T-Mobile: `5852274686@tmomail.net`
- Sprint: `5852274686@messaging.sprintpcs.com`

Replace 5852274686 with actual 10-digit phone (no dashes/spaces)
Enter in "Primary Emergency Contact" field

### 4. Gmail App Password (Required for SMS/Email)
1. Go to: https://myaccount.google.com/apppasswords
2. Create "Mail" app password
3. Copy 16-character password
4. In Settings ‚Üí Email Notifications:
   - SMTP Server: smtp.gmail.com
   - SMTP Port: 587
   - Username: your-gmail@gmail.com
   - Password: [paste app password]
5. Save Settings

### 5. Enable Motion Recording to SD Card
In Settings ‚Üí Camera & Recording:
- ‚úì Enable Motion Recording to SD Card
- Recording Resolution: 1280x720 (HD)
- Recording Duration: 30 seconds
- Motion Sensitivity: Medium
- Storage Retention: 7 days
- Save Settings

## üìπ HOW MOTION RECORDING WORKS

- Runs every 2 seconds in background
- Uses camera coordinator (no conflicts with streaming!)
- When motion detected:
  * Records video to SD card
  * Saves to ~/ME_CAM-DEV/recordings/
  * Filename: motion_YYYYMMDD_HHMMSS.mp4
  * Continues if motion persists
  * Stops 5 seconds after motion stops
  * Logs file size on completion

## üìä VIEW RECORDINGS

Dashboard ‚Üí Recordings Section shows:
- All saved videos with timestamps
- File sizes
- Download buttons
- Delete buttons
- Storage usage (Used/Available/Total GB)

## üö® EMERGENCY ALERT TYPES

### Medical (Seizure Detection)
- Mode: Medical or Both
- Triggers: Unusual motion patterns
- Alerts: Primary Emergency Contact (wife)
- Includes: Video evidence

### Security (Theft/Break-in)
- Mode: Security or Both
- Triggers: Person detected when nobody home
- Alerts: Owner + Security Contacts
- Includes: Video for police/insurance

### Manual SOS Button
- Dashboard ‚Üí "üö® SOS Alert" button
- Sends to Primary Emergency Contact
- Includes latest video recording

## ‚öôÔ∏è NEW CONFIGURATION OPTIONS

Added to Settings page:
1. Device Name - Custom camera name
2. Device Location - Physical location
3. Recording Resolution - Separate from stream (HD quality)
4. Recording Duration - 10-300 seconds
5. Motion Sensitivity - High/Medium/Low
6. Storage Retention - Auto-delete old files (1-365 days)
7. Motion Recording Toggle - Enable/disable SD card recording
8. Emergency Mode - Manual/Medical/Security/Both
9. Multiple Contacts - Different alerts to different people

Each Pi can have unique configuration saved in:
~/ME_CAM-DEV/config/config.json

## üîß CAMERA COORDINATOR (PREVENTS CONFLICTS)

**Problem Solved:** Camera can only be used by ONE process
**Solution:** Intelligent queue system

How it works:
- Streaming: High priority (always smooth)
- Motion Detection: Normal priority (waits turn)
- Recording: High priority (captures events)
- 500ms delay between operations
- Automatic retry if busy

Verify working:
```bash
tail -f ~/ME_CAM-DEV/logs/mecam.log | grep CAMERA
```
Should see: "Access granted" and "Access released" messages
NO "timeout" or "device busy" errors!

## üîç MONITORING & VERIFICATION

### Check Service Status
```bash
sudo systemctl status mecamera
```
Look for:
- Active: active (running)
- [MAIN] Motion detection service initialized
- [MOTION] Motion detection service started

### View Live Logs
```bash
# All logs
tail -f ~/ME_CAM-DEV/logs/mecam.log

# Motion only
tail -f ~/ME_CAM-DEV/logs/mecam.log | grep MOTION

# Camera coordination
tail -f ~/ME_CAM-DEV/logs/mecam.log | grep CAMERA

# Emergency alerts
tail -f ~/ME_CAM-DEV/logs/mecam.log | grep EMERGENCY
```

### Test Motion Detection
1. Wave hand in front of camera
2. Check logs: [MOTION] Motion detected
3. Wait 30 seconds
4. Check: ls -lh ~/ME_CAM-DEV/recordings/
5. Should see new .mp4 file

### Test Emergency Alert
1. Configure contacts & email
2. Click SOS button
3. Check wife's phone (1-2 minutes)

## üîÑ DEPLOYMENT COMMANDS

### One Command Update (from your PC)
```powershell
ssh pi@raspberrypi.local "cd ~/ME_CAM-DEV && git pull origin main && sudo systemctl restart mecamera && sleep 3 && sudo systemctl status mecamera"
```

### Manual Deployment (from Pi)
```bash
ssh pi@raspberrypi.local
cd ~/ME_CAM-DEV
git pull origin main
sudo systemctl restart mecamera
sudo systemctl status mecamera
```

## ‚úÖ VERIFICATION CHECKLIST

After deployment verify:
- [ ] Camera streaming works (no black screen)
- [ ] Motion detection started (check logs)
- [ ] Camera coordinator working (check logs)
- [ ] Emergency contacts configured
- [ ] Email configured (Gmail App Password)
- [ ] Test SOS ‚Üí Wife receives alert
- [ ] Motion recording enabled
- [ ] Wave hand ‚Üí Recording created
- [ ] Recordings on dashboard
- [ ] Storage shows space used
- [ ] No camera busy errors
- [ ] Auto-starts on reboot

## üÜò TROUBLESHOOTING

### Motion Not Recording
```bash
# Check enabled
grep "motion_only" ~/ME_CAM-DEV/config/config.json
# Should be true

# Check directory
ls -la ~/ME_CAM-DEV/recordings/

# Fix permissions
chmod -R 755 ~/ME_CAM-DEV/recordings/

# Check space
df -h

# Restart
sudo systemctl restart mecamera
```

### Emergency Alerts Not Sending
1. Verify email enabled in settings
2. Must use Gmail App Password (not regular password)
3. Test carrier SMS gateway correct
4. Check first message not in spam
5. Try email instead of SMS gateway

### Camera Conflicts (should NOT happen)
```bash
# Verify coordinator being used
grep "camera_coordinator" ~/ME_CAM-DEV/libcamera_streamer.py

# Check no other camera processes
ps aux | grep libcamera
# Only mecamera service should be listed

# Restart service
sudo systemctl restart mecamera
```

### Wife Not Receiving SMS
Common fixes:
1. Wrong carrier gateway
2. Wrong phone number format (must be 10 digits)
3. Gmail blocking (use App Password)
4. First message in spam
5. Use email: wife@example.com instead

## üìû QUICK REFERENCE

### URLs
- Dashboard: http://raspberrypi.local:8080
- Settings: http://raspberrypi.local:8080/config

### Directories
- Project: ~/ME_CAM-DEV
- Recordings: ~/ME_CAM-DEV/recordings/
- Config: ~/ME_CAM-DEV/config/config.json
- Logs: ~/ME_CAM-DEV/logs/mecam.log

### Commands
```bash
# Service
sudo systemctl status mecamera
sudo systemctl restart mecamera

# Logs
tail -f ~/ME_CAM-DEV/logs/mecam.log

# Update
cd ~/ME_CAM-DEV && git pull origin main

# Recordings
ls -lh ~/ME_CAM-DEV/recordings/

# Test camera
libcamera-still --list-cameras
```

## üéì COMPLETE SETUP CHECKLIST

1. [ ] Deploy code: git pull origin main
2. [ ] Restart service: sudo systemctl restart mecamera
3. [ ] Configure emergency contacts (wife's SMS gateway)
4. [ ] Setup Gmail App Password
5. [ ] Test SOS button ‚Üí Verify wife gets alert
6. [ ] Enable motion recording in settings
7. [ ] Test motion ‚Üí Wave hand, check recordings
8. [ ] Set emergency mode (Medical/Security/Both)
9. [ ] Monitor 24 hours ‚Üí Check logs work
10. [ ] Adjust sensitivity if needed

--------------------------------------------
üéâ YOUR ME_CAM IS NOW A COMPLETE EMERGENCY 
   MONITORING & RECORDING SYSTEM! üö®üìπ
--------------------------------------------


============================================
üì± EMERGENCY SMS SETUP GUIDE
============================================

## Quick Emergency SMS Setup

### Step 1: Determine Your Carrier
You need to know the phone carrier to use email-to-SMS gateway.

### Step 2: Configure Email in ME_CAM

1. **Go to web dashboard:** `http://raspberrypi.local:8080`
2. **Login** with your credentials
3. **Go to Config/Settings**
4. **Enable Email** and enter:

#### If using Gmail:
```
SMTP Server: smtp.gmail.com
SMTP Port: 587
Username: your-gmail@gmail.com
Password: [App Password - see below]
From Address: your-gmail@gmail.com
To Address: [carrier-gateway-below]
```

#### Carrier SMS Gateways (replace phone with actual 10-digit number):
- **Verizon:** `5852274686@vtext.com`
- **AT&T:** `5852274686@txt.att.net`
- **T-Mobile:** `5852274686@tmomail.net`
- **Sprint:** `5852274686@messaging.sprintpcs.com`
- **US Cellular:** `5852274686@email.uscc.net`

### Step 3: Get Gmail App Password

1. Go to: https://myaccount.google.com/apppasswords
2. Sign in to your Gmail account
3. Create app password for "Mail"
4. Copy the 16-character password
5. Use this password (NOT your regular Gmail password)

### Step 4: Test Configuration

Run on your Pi:
```bash
cd ~/ME_CAM-DEV
source venv/bin/activate

python3 << 'EOF'
from cloud.email_notifier import EmailNotifier

# Replace with YOUR values:
notifier = EmailNotifier(
    enabled=True,
    smtp_host='smtp.gmail.com',
    smtp_port=587,
    username='your-email@gmail.com',
    password='your-app-password',
    from_addr='your-email@gmail.com',
    to_addr='5852274686@vtext.com'  # Change vtext.com to YOUR carrier
)

notifier.send_alert(
    "TEST - ME_CAM Emergency",
    "This is a test message. If you receive this, emergency alerts are working!"
)
print("Test message sent!")
EOF
```

### Troubleshooting

**Not receiving messages?**

1. **Check spam folder** - first message might go to spam
2. **Verify carrier gateway** - wrong gateway = no message
3. **Check Gmail app password** - must use app password, not regular password
4. **Check phone number format** - must be 10 digits, no dashes/spaces: `5852274686`

**Gmail Security Error?**

Enable "Less secure app access" or use App Passwords:
https://support.google.com/accounts/answer/185833

**Still not working?**

Use a free SMS API service:
- Twilio (free trial): https://www.twilio.com
- SendGrid SMS
- AWS SNS

Or just use email - most reliable option.


============================================
üö® COMPLETE EMERGENCY FEATURES GUIDE
============================================

## Overview

ME_CAM now includes comprehensive emergency notification features for both **medical monitoring** (seizure detection, falls) and **security alerts** (theft, break-ins). The system uses AI-enhanced motion detection with intelligent camera coordination to prevent conflicts between live streaming and recording.

---

## üö® Emergency Modes

### 1. **Manual Mode** (Default)
- Emergency alerts only when you press the SOS button
- No automatic detection
- Safest option for testing

### 2. **Medical Monitoring Mode**
- AI detects unusual motion patterns (seizures, falls, prolonged inactivity)
- Automatically alerts your wife/family
- Includes video evidence of the event

### 3. **Security Mode**
- Detects intrusions, break-ins, theft
- Sends alerts with video to property owner
- Can forward to police and insurance companies

### 4. **Both Medical & Security**
- Combined monitoring
- Different alert recipients for different event types

---

## üìã Setup Instructions

### Step 1: Update Your Pi

```bash
ssh pi@raspberrypi.local
cd ~/ME_CAM-DEV
git pull origin main
```

### Step 2: Restart the Service

```bash
sudo systemctl restart mecamera
sudo systemctl status mecamera
```

---

## ‚öôÔ∏è Configuration

### Access Settings Page

1. Open browser: `http://raspberrypi.local:8080`
2. Login with your credentials
3. Click **‚öôÔ∏è Configure** at bottom of dashboard
4. Scroll to **üö® Emergency Contacts** section (red border)

### Emergency Contacts Configuration

#### **Device Location**
- Enter physical location: "Living Room", "Front Door", "Bedroom", etc.
- This is included in all emergency alerts

#### **Primary Emergency Contact (Medical)**
- For medical emergencies (seizures, falls, unresponsive)
- Enter phone number using carrier SMS gateway OR email
- **SMS Examples:**
  - Verizon: `5852274686@vtext.com`
  - AT&T: `5852274686@txt.att.net`
  - T-Mobile: `5852274686@tmomail.net`
  - Sprint: `5852274686@messaging.sprintpcs.com`
  
  *(Replace `5852274686` with wife's phone number, no dashes or spaces)*

- **Email Example:** `wife@example.com`

#### **Property Owner Email (Security)**
- For security alerts (theft, break-in)
- Enter your email address
- Receives video evidence automatically

#### **Additional Security Contacts**
- Comma-separated list
- Police department email: `police@dept.gov`
- Insurance company: `claims@insurance.com`

#### **Emergency Detection Mode**
- **Manual**: SOS button only (safest for testing)
- **Medical**: Automatic medical alerts
- **Security**: Automatic intrusion alerts
- **Both**: All alerts enabled

---

## üìß Email Configuration

Emergency alerts require email to be configured. This works for both email and SMS (via carrier gateways).

### Gmail Setup (Recommended)

1. Go to Settings ‚Üí **üìß Email Notifications**
2. Check **Enable Email Alerts**
3. Enter:
   - **SMTP Server**: `smtp.gmail.com`
   - **SMTP Port**: `587`
   - **Username**: `your-gmail@gmail.com`
   - **Password**: **[See below for App Password]**
   - **From Address**: `your-gmail@gmail.com`
   - **To Address**: `your-email@gmail.com` (or leave blank, will use emergency contacts)

### Getting Gmail App Password

**IMPORTANT**: You CANNOT use your regular Gmail password. You must create an "App Password":

1. Go to: https://myaccount.google.com/apppasswords
2. Sign in to your Gmail account
3. Select **Mail** as the app
4. Select **Other** as the device, name it "ME_CAM"
5. Click **Generate**
6. Copy the 16-character password (no spaces)
7. Paste this into the ME_CAM password field

### Testing Email

After configuring email:
1. Save settings
2. Go to dashboard
3. Click **üö® SOS Alert** button
4. Check your phone/email for the alert

---

## üéØ How Emergency Alerts Work

### Manual SOS Button

**Location**: Dashboard ‚Üí **Quick Actions** ‚Üí Red **üö® SOS Alert** button

**What happens:**
1. You press the button
2. System finds most recent video recording
3. Sends emergency alert email to Primary Emergency Contact
4. Includes video attachment (if available)
5. Email contains:
   - Device name and location
   - Timestamp
   - Emergency contact info
   - Video evidence link

### Automatic Medical Alerts

**When enabled** (Emergency Mode = Medical or Both):

1. Motion detection runs in background
2. AI analyzes motion patterns
3. Detects:
   - Sudden falls (rapid downward motion)
   - Seizure-like movements (rapid repetitive motion)
   - Prolonged stillness after activity
4. Triggers medical emergency alert
5. Sends to **Primary Emergency Contact** (your wife)
6. Includes 30-second video clip of the event

**Alert Format:**
```
Subject: üö® MEDICAL EMERGENCY - SEIZURE

URGENT - MEDICAL EMERGENCY DETECTED

Event Type: SEIZURE
Device: Living Room Camera
Location: Living Room
Time: 2026-01-13 18:45:32

Primary Contact: +1-555-0123

This is an automated alert from ME_CAM monitoring system.
Please check on the person immediately.

Video evidence: Attached
```

### Automatic Security Alerts

**When enabled** (Emergency Mode = Security or Both):

1. Motion detection runs in background
2. AI detects person in frame (not just motion)
3. If person detected when nobody should be home:
4. Triggers security alert
5. Sends to **Owner Email** and **Security Contacts**
6. Includes video evidence for police report

**Alert Format:**
```
Subject: üö® SECURITY ALERT - THEFT

SECURITY INCIDENT DETECTED

Incident Type: THEFT
Device: Front Door Camera
Location: Front Door
Time: 2026-01-13 02:15:44

Video Evidence: Attached

This alert has been sent to:
- Property Owner: owner@example.com
- Security Contacts: police@dept.gov, insurance@company.com

For police report, reference:
- Device ID: Front Door Camera
- Timestamp: 2026-01-13T02:15:44
- Evidence File: motion_20260113_021544.mp4
```

---

## üîß Technical Details

### Camera Coordination

**Problem Solved**: Camera streaming and motion detection conflicted because libcamera can only be accessed by one process at a time.

**Solution**: New `camera_coordinator.py` module:
- Manages queue for camera access
- Streaming gets **high priority** (always works)
- Motion detection gets **normal priority** (waits for streaming to finish)
- Minimum 500ms delay between camera operations
- Prevents device busy errors

**Result**:
- ‚úÖ Live camera streaming works smoothly
- ‚úÖ Motion detection runs every 2-5 seconds
- ‚úÖ No more camera lock conflicts
- ‚úÖ Both features can run simultaneously

### Motion Detection Behavior

- Runs in background thread
- Checks every 2 seconds
- When motion detected:
  - Starts 30-second recording
  - Continues recording if motion persists
  - Stops 5 seconds after motion stops
- Saves to `~/ME_CAM-DEV/recordings/`
- Filename: `motion_YYYYMMDD_HHMMSS.mp4`

### Emergency Handler

New `emergency_handler.py` module provides:
- **Cooldown**: 60 seconds between alerts (prevents spam)
- **Video attachment**: Always includes latest recording
- **Google Drive upload**: If enabled, uploads evidence
- **Multiple recipients**: Can send to multiple contacts
- **Event types**: Medical (seizure, fall) and Security (theft, break-in)

---

## üì± SMS Setup for Wife's Phone

### Carrier Gateway Examples

**Example for Verizon:**
```
Primary Emergency Contact: 5852274686@vtext.com
```

**Example for AT&T:**
```
Primary Emergency Contact: 5852274686@txt.att.net
```

**Example for T-Mobile:**
```
Primary Emergency Contact: 5852274686@tmomail.net
```

**Example for Sprint:**
```
Primary Emergency Contact: 5852274686@messaging.sprintpcs.com
```

Replace `5852274686` with actual 10-digit phone number (no dashes/spaces).


============================================
üìπ QUICK DEPLOYMENT & MOTION RECORDING GUIDE
============================================

## üéØ QUICK SETUP STEPS

### 1. Deploy New Features to Pi
```bash
ssh pi@raspberrypi.local
cd ~/ME_CAM-DEV
git pull origin main
sudo systemctl restart mecamera
sudo systemctl status mecamera
```

### 2. Configure Emergency Contacts
1. Open browser: http://raspberrypi.local:8080
2. Login with your credentials
3. Click **‚öôÔ∏è Configure** (bottom of dashboard)
4. Scroll to **üö® Emergency Contacts** section (red border)
5. Fill in:
   - **Device Location**: "Living Room", "Bedroom", etc.
   - **Primary Emergency Contact**: Wife's phone (SMS via email gateway)
   - **Owner Email**: Your email for security alerts
   - **Emergency Mode**: Select Medical, Security, or Both

### 3. Setup SMS to Wife's Phone
To send text messages when emergency detected:

**Get Phone Carrier Gateway:**
- Verizon: `5852274686@vtext.com`
- AT&T: `5852274686@txt.att.net`
- T-Mobile: `5852274686@tmomail.net`
- Sprint: `5852274686@messaging.sprintpcs.com`

Replace `5852274686` with actual 10-digit phone number (no dashes/spaces)

**Enter in Primary Emergency Contact field**

### 4. Configure Email (Required for SMS)
1. Go to Settings ‚Üí Email Notifications
2. Enable Email Alerts
3. Enter Gmail info:
   - SMTP Server: `smtp.gmail.com`
   - SMTP Port: `587`
   - Username: `your-gmail@gmail.com`
   - Password: **[Use App Password - see below]**

**Get Gmail App Password:**
1. Go to: https://myaccount.google.com/apppasswords
2. Create password for "Mail"
3. Copy 16-character password
4. Paste into ME_CAM settings

### 5. Test Emergency Alert
1. Save all settings
2. Go to dashboard
3. Click **üö® SOS Alert** button
4. Check wife's phone for text message

---

## üìπ MOTION RECORDING TO SD CARD

### Enable Motion Recording
1. Go to Settings ‚Üí Camera & Recording Settings
2. Check **Enable Motion Recording to SD Card**
3. Configure:
   - **Recording Resolution**: 1280x720 (HD recommended)
   - **Recording Duration**: 30 seconds (or custom)
   - **Motion Sensitivity**: Medium (recommended)
   - **Storage Retention**: 7 days (auto-delete old recordings)
4. Save Settings

### How Motion Recording Works
- Camera coordinator manages access (no conflicts with streaming)
- Motion detection runs every 2 seconds in background
- When motion detected:
  * Records video to SD card
  * Saves to `~/ME_CAM-DEV/recordings/`
  * Filename: `motion_YYYYMMDD_HHMMSS.mp4`
  * Continues recording if motion persists
  * Stops 5 seconds after motion stops
  * File size verification logged

### View Recordings
- Dashboard ‚Üí Recordings section
- Shows all saved videos with:
  * Timestamp
  * File size
  * Download button
  * Delete button
- Storage usage displayed (Used/Available/Total)

### Check Recording Status
```bash
# View motion detection logs
tail -f ~/ME_CAM-DEV/logs/mecam.log | grep MOTION

# Should see:
# [MOTION] Recording started: recordings/motion_20260113_184532.mp4
# [MOTION] Recording saved: recordings/motion_20260113_184532.mp4 (12.45 MB)
```

### Troubleshooting Recording Issues

**Problem: Motion detected but no files saved**
```bash
# Check recordings directory exists
ls -lh ~/ME_CAM-DEV/recordings/

# Check disk space
df -h

# Check permissions
chmod 755 ~/ME_CAM-DEV/recordings/

# Check camera access
libcamera-vid --list-cameras
```

**Problem: Files are 0 bytes or corrupted**
- Check SD card health: `sudo fsck /dev/mmcblk0p2`
- Check SD card not full: `df -h`
- Reduce recording resolution in settings
- Reduce recording duration

**Problem: Camera busy errors**
- Camera coordinator should prevent this
- Check logs: `grep "camera busy" ~/ME_CAM-DEV/logs/mecam.log`
- Verify motion service using coordinator
- Restart service: `sudo systemctl restart mecamera`

---

## üö® EMERGENCY ALERT TYPES

### Medical Emergency (Seizure Detection)
**When:** Emergency Mode = Medical or Both
**Triggers:** Unusual motion patterns detected
**Alert Sent To:** Primary Emergency Contact (wife)
**Includes:** Video evidence of event

**Alert Format:**
```
Subject: üö® MEDICAL EMERGENCY - SEIZURE

URGENT - MEDICAL EMERGENCY DETECTED

Event Type: SEIZURE
Device: Living Room Camera
Location: Living Room
Time: 2026-01-13 18:45:32
Primary Contact: 5551234567@vtext.com

Video evidence: Attached
```

### Security Alert (Theft/Break-in)
**When:** Emergency Mode = Security or Both
**Triggers:** Person detected when nobody home
**Alert Sent To:** Owner email + Security contacts
**Includes:** Video evidence for police/insurance

**Alert Format:**
```
Subject: üö® SECURITY ALERT - THEFT

SECURITY INCIDENT DETECTED

Incident Type: THEFT
Device: Front Door Camera  
Location: Front Door
Time: 2026-01-13 02:15:44

Video Evidence: Attached
Sent to: owner@example.com, police@dept.gov, insurance@company.com
```

### Manual SOS Button
**When:** Anytime you press SOS button
**Triggers:** Manual button press on dashboard
**Alert Sent To:** Primary Emergency Contact
**Includes:** Latest video recording (if available)

---

## ‚öôÔ∏è ENHANCED CONFIGURATION OPTIONS

### New Settings Added:
1. **Device Name**: Custom name for camera (appears on dashboard/alerts)
2. **Device Location**: Physical location (Living Room, Bedroom, etc.)
3. **Recording Resolution**: Separate from stream resolution (HD quality)
4. **Recording Duration**: 10-300 seconds configurable
5. **Motion Sensitivity**: High/Medium/Low presets
6. **Storage Retention**: Auto-delete old recordings (1-365 days)
7. **Motion Recording Toggle**: Enable/disable recording to SD card
8. **Emergency Mode**: Manual/Medical/Security/Both
9. **Multiple Emergency Contacts**: Different contacts for different alerts

### Per-Device Customization
Each Raspberry Pi can have unique configuration:
- Different device names
- Different emergency contacts  
- Different recording settings
- Different sensitivity levels
- Custom storage retention

Configuration saved in: `~/ME_CAM-DEV/config/config.json`

---

## üîß CAMERA COORDINATOR EXPLAINED

### Problem Solved
Previously: Camera could only be used by ONE process at a time
- Streaming OR Motion Detection (not both)
- "Device busy" errors
- Camera lock conflicts

Now: Intelligent queue system allows both!

### How It Works
1. **Streaming**: High priority (always smooth)
2. **Motion Detection**: Normal priority (waits turn)
3. **Recording**: High priority (captures events)
4. Minimum 500ms delay between operations
5. Automatic retry if busy

### Verify Coordination Working
```bash
# Check camera access logs
tail -f ~/ME_CAM-DEV/logs/mecam.log | grep CAMERA

# Should see:
# [CAMERA] Access granted to streaming
# [CAMERA] Access released by streaming
# [CAMERA] Access granted to motion_detection
# [CAMERA] Access released by motion_detection

# NO "timeout" or "busy" errors!
```

---

## üìä MONITORING & VERIFICATION

### Check Service Status
```bash
sudo systemctl status mecamera
```
Look for:
- `Active: active (running)`
- `[MAIN] Motion detection service initialized`
- `[MOTION] Motion detection service started`

### View Live Logs
```bash
# All logs
tail -f ~/ME_CAM-DEV/logs/mecam.log

# Motion detection only
tail -f ~/ME_CAM-DEV/logs/mecam.log | grep MOTION

# Camera coordination
tail -f ~/ME_CAM-DEV/logs/mecam.log | grep CAMERA

# Emergency alerts
tail -f ~/ME_CAM-DEV/logs/mecam.log | grep EMERGENCY
```

### Test Motion Detection
1. Wave hand in front of camera
2. Check logs for: `[MOTION] Motion detected`
3. Wait 30 seconds
4. Check recordings directory: `ls -lh ~/ME_CAM-DEV/recordings/`
5. Should see new .mp4 file with current timestamp

### Test Emergency Alert
1. Configure emergency contacts
2. Enable email with Gmail App Password
3. Click SOS button on dashboard
4. Check wife's phone/email within 1-2 minutes

---

## üîÑ DEPLOYMENT COMMANDS

### Quick Update (From PC)
```powershell
# One command to update Pi from your PC
ssh pi@raspberrypi.local "cd ~/ME_CAM-DEV && git pull origin main && sudo systemctl restart mecamera && sleep 3 && sudo systemctl status mecamera"
```

### Manual Deployment (From Pi)
```bash
# SSH into Pi
ssh pi@raspberrypi.local
cd ~/ME_CAM-DEV
git pull origin main
sudo systemctl restart mecamera
```

---

## ‚úÖ VERIFICATION CHECKLIST

After deployment verify:
- [ ] Camera streaming works (no black screen)
- [ ] Motion detection started (check logs)
- [ ] Camera coordinator working (check logs)
- [ ] Emergency contacts configured
- [ ] Email configured (Gmail App Password)
- [ ] Test SOS ‚Üí Wife receives alert
- [ ] Motion recording enabled
- [ ] Wave hand ‚Üí Recording created
- [ ] Recordings on dashboard
- [ ] Storage shows space used
- [ ] No camera busy errors
- [ ] Auto-starts on reboot

---

## üÜò TROUBLESHOOTING

### Motion Not Recording
```bash
# Check enabled
grep "motion_only" ~/ME_CAM-DEV/config/config.json
# Should be true

# Check directory
ls -la ~/ME_CAM-DEV/recordings/

# Fix permissions
chmod -R 755 ~/ME_CAM-DEV/recordings/

# Check space
df -h

# Restart
sudo systemctl restart mecamera
```

### Emergency Alerts Not Sending
1. Verify email enabled in settings
2. Must use Gmail App Password (not regular password)
3. Test carrier SMS gateway correct
4. Check first message not in spam
5. Try email instead of SMS gateway

### Camera Conflicts (should NOT happen)
```bash
# Verify coordinator being used
grep "camera_coordinator" ~/ME_CAM-DEV/libcamera_streamer.py

# Check no other camera processes
ps aux | grep libcamera
# Only mecamera service should be listed

# Restart service
sudo systemctl restart mecamera
```

### Wife Not Receiving SMS
Common fixes:
1. Wrong carrier gateway
2. Wrong phone number format (must be 10 digits)
3. Gmail blocking (use App Password)
4. First message in spam
5. Use email: wife@example.com instead


============================================
üîß COMPLETE TROUBLESHOOTING & FIX GUIDE
(January 13, 2026 - Video & Motion Issues)
============================================

## üéØ WHAT'S BROKEN & HOW TO FIX

### ISSUE 1: Live Video Not Displaying
**Root Cause**: Dashboard was using <video> tag instead of <img> for MJPEG stream

**FIX STATUS**: ‚úÖ FIXED
- Dashboard.html updated to use: `<img src="/api/stream">`
- MJPEG stream now displays correctly
- Auto-reconnect on failure with 2 second retry

**Deploy Fix**:
```bash
cd ~/ME_CAM-DEV
git pull origin main
sudo systemctl restart mecamera
# Dashboard video should now display!
```

### ISSUE 2: Motion Detection Not Recording Videos
**Root Cause**: Multiple possible issues:
1. motion_service not starting
2. camera_coordinator conflicts
3. libcamera-vid timeout or permissions
4. recordings directory doesn't exist

**FIX STEPS**:
```bash
# SSH into Pi
ssh pi@raspberrypi.local

# Verify recordings directory
mkdir -p ~/ME_CAM-DEV/recordings
chmod 755 ~/ME_CAM-DEV/recordings

# Check motion service status
sudo systemctl status mecamera | grep -i motion

# View live motion logs
tail -f ~/ME_CAM-DEV/logs/mecam.log | grep MOTION

# Test recording manually
libcamera-vid -t 5000 -o ~/ME_CAM-DEV/recordings/test.mp4

# If test works but dashboard doesn't record:
# Service might need restart
sudo systemctl restart mecamera
```

### ISSUE 3: No Performance Settings in Config Page
**Root Cause**: Settings exist in HTML but may not be scrolling properly

**FIX**: Scroll down in Settings page to find:
- ‚ö° Performance Settings (green section)
- ‚úì Use Fast Streaming checkbox
- Stream FPS slider
- Motion Check Interval

**If still missing**:
```bash
cd ~/ME_CAM-DEV
grep -n "Performance Settings" web/templates/config.html
# Should show: line 341
```

### ISSUE 4: Dashboard Slow / 1-2 FPS
**Root Cause**: Fast streaming not enabled OR picamera2 not installed

**FIX STEPS**:

**Step A: Ensure picamera2 installed**
```bash
ssh pi@raspberrypi.local
sudo apt update
sudo apt install -y python3-picamera2

# Verify installation
python3 -c "from picamera2 import Picamera2; print('‚úì picamera2 installed')"
```

**Step B: Enable in Dashboard**
1. Open: http://raspberrypi.local:8080
2. Click ‚öôÔ∏è Configure
3. **Scroll down** to "‚ö° Performance Settings" (green section)
4. Check: ‚úì Use Fast Streaming (picamera2) - RECOMMENDED
5. Set: Target Stream FPS = 15 (or 20-30 if CPU allows)
6. Click: Save Settings
7. Dashboard auto-restarts

**Step C: Restart Service**
```bash
sudo systemctl restart mecamera

# Verify it started
sudo systemctl status mecamera | head -20

# Should show: [CAMERA] Fast streamer initialized
```

**Step D: Test Speed**
- Open dashboard: http://raspberrypi.local:8080
- Watch live camera for smoothness
- Should be 15-30 FPS (smooth like phone!)
- Not 1-2 FPS (jerky)

### ISSUE 5: Website Not Secure / No Login Working
**Root Cause**: Authentication exists but PIN setup might be in first-run

**Verify Auth Working**:
1. Log out: Click Logout
2. Try access: http://raspberrypi.local:8080
3. Should redirect to login

**If no login**:
```bash
# Check config has users
grep -A5 '"users"' ~/ME_CAM-DEV/config/config.json | head -20

# Check for first-run status
grep "first_run" ~/ME_CAM-DEV/config/config.json

# If needed, reset and re-setup
sudo systemctl stop mecamera
rm ~/ME_CAM-DEV/config/config.json
sudo systemctl start mecamera
# Will show first-run setup wizard on access
```

============================================
‚ö° QUICK REFERENCE CARD
============================================

üìç DASHBOARD ACCESS
  URL:          http://raspberrypi.local:8080
  Login:        Your username/password
  PIN (optional): Configurable in settings

üéØ QUICK FEATURES
  üö® SOS Button:        Click "üö® SOS Alert" for immediate emergency alert
  üìπ Recordings:        See all motion-triggered videos on dashboard
  ‚öôÔ∏è  Settings:         Configure everything including emergency contacts
  üìä Storage:           View SD card usage (used/available/total GB)

üö® EMERGENCY MODES

  Medical Monitoring (Wife - Seizure Alert)
  ‚îú‚îÄ Mode: Medical or Both
  ‚îú‚îÄ Setup: Primary Contact = wife@sms.gateway (e.g., 5551234567@vtext.com)
  ‚îú‚îÄ Trigger: Unusual motion patterns detected automatically
  ‚îî‚îÄ Alert: SMS to wife + video evidence

  Security Mode (Police/Insurance - Theft Alert)
  ‚îú‚îÄ Mode: Security or Both
  ‚îú‚îÄ Setup: Owner Email + Security Contacts (comma-separated)
  ‚îú‚îÄ Trigger: Person detected when nobody home
  ‚îî‚îÄ Alert: Email to police/insurance with video

  Manual SOS Button
  ‚îú‚îÄ Mode: Any mode
  ‚îú‚îÄ Setup: Primary contact configured
  ‚îú‚îÄ Trigger: Click button anytime
  ‚îî‚îÄ Alert: Immediate notification + latest video

üì± SMS SETUP (Wife's Phone)
  
  Verizon:      5852274686@vtext.com
  AT&T:         5852274686@txt.att.net
  T-Mobile:     5852274686@tmomail.net
  Sprint:       5852274686@messaging.sprintpcs.com
  (Replace 5852274686 with wife's 10-digit number, no dashes/spaces)

  ‚ö†Ô∏è  REQUIRES Gmail App Password (not regular password)

üìß EMAIL SETUP (Required for SMS/Alerts)

  1. Go to:       https://myaccount.google.com/apppasswords
  2. Create:      "Mail" app password
  3. Copy:        16-character password
  4. Enter in Settings ‚Üí Email Notifications:
     SMTP Server: smtp.gmail.com
     SMTP Port:   587
     Username:    your-gmail@gmail.com
     Password:    [16-character app password]

üé¨ MOTION RECORDING SETTINGS

  Recording Enabled:     ‚úì Enable Motion Recording to SD Card
  Resolution:            1280x720 (HD recommended)
  Duration:              30 seconds (configurable 10-300)
  Sensitivity:           Medium (High/Medium/Low)
  Storage Retention:     7 days (auto-delete older files)
  
  Videos save to: ~/ME_CAM-DEV/recordings/
  Filename format: motion_YYYYMMDD_HHMMSS.mp4

üîß SERVICE MANAGEMENT

  Check Status:   sudo systemctl status mecamera
  Start Service:  sudo systemctl start mecamera
  Stop Service:   sudo systemctl stop mecamera
  Restart:        sudo systemctl restart mecamera
  View Logs:      tail -f ~/ME_CAM-DEV/logs/mecam.log

üìä MONITORING COMMANDS

  View All Logs:           tail -f ~/ME_CAM-DEV/logs/mecam.log
  Motion Detection Only:   tail -f ~/ME_CAM-DEV/logs/mecam.log | grep MOTION
  Camera Coordination:     tail -f ~/ME_CAM-DEV/logs/mecam.log | grep CAMERA
  Emergency Alerts:        tail -f ~/ME_CAM-DEV/logs/mecam.log | grep EMERGENCY
  
  List Recordings:         ls -lh ~/ME_CAM-DEV/recordings/
  Check Disk Space:        df -h
  Camera Test:             libcamera-still --list-cameras

üîÑ DEPLOYMENT/UPDATE

  From your PC:
  $ ssh pi@raspberrypi.local "cd ~/ME_CAM-DEV && git pull origin main && \
    sudo systemctl restart mecamera && sudo systemctl status mecamera"

  From Pi directly:
  $ cd ~/ME_CAM-DEV
  $ git pull origin main
  $ sudo systemctl restart mecamera

‚úÖ VERIFICATION STEPS

  1. Dashboard loads at http://raspberrypi.local:8080 ?
  2. Live camera feed displaying ?
  3. Settings page has Emergency Contacts section ?
  4. Motion recording checkbox enabled ?
  5. Email configured with Gmail App Password ?
  6. Emergency contacts filled in ?
  7. Wave hand in front of camera - recording created ?
  8. Click SOS button - wife/contact gets alert ?
  9. No timeout/busy errors in logs ?
  10. Service auto-starts on reboot ?

üÜò TROUBLESHOOTING QUICK FIXES

  Motion not recording?
    $ grep "motion_only" ~/ME_CAM-DEV/config/config.json
    Should show: "motion_only": true
    $ sudo systemctl restart mecamera

  No emergency alerts?
    ‚Ä¢ Check Gmail App Password (not regular password!)
    ‚Ä¢ Check emergency contacts configured
    ‚Ä¢ Check email enabled in settings
    ‚Ä¢ Try email instead of SMS gateway
    ‚Ä¢ Test: Click SOS button, check logs

  Camera not displaying?
    $ libcamera-still --list-cameras
    $ sudo systemctl restart mecamera

  Motion timeouts?
    This is normal! Streaming has priority.
    System retries automatically every 2 seconds.

üìã CONFIGURATION FILES

  Config:      ~/ME_CAM-DEV/config/config.json
  Logs:        ~/ME_CAM-DEV/logs/mecam.log
  Recordings:  ~/ME_CAM-DEV/recordings/
  Service:     /etc/systemd/system/mecamera.service

üéì RECOMMENDED SETUP ORDER

  1. Deploy code (git pull + restart)
  2. Configure emergency contacts
  3. Setup Gmail App Password
  4. Enable motion recording
  5. Test SOS button
  6. Test motion detection
  7. Adjust sensitivity if needed
  8. Enable Google Drive (optional)
  9. Monitor logs for 24 hours
  10. Verify all features working

‚ö° KEY SYSTEM IMPROVEMENTS

  ‚úÖ Camera Coordinator: Streaming + Motion Detection (no conflicts!)
  ‚úÖ Emergency Handler: Medical + Security alert types
  ‚úÖ Motion Recording: HD video to SD card with coordinator
  ‚úÖ Smart Settings: Configurable resolution/duration/sensitivity
  ‚úÖ Multiple Contacts: Different alerts for different situations
  ‚úÖ SMS Support: Via carrier email gateways
  ‚úÖ File Verification: Logs file size when recordings saved
  ‚úÖ Auto-Cleanup: Old files automatically deleted
  ‚úÖ Documentation: 1500+ lines of guides and examples

üåü WHAT YOU CAN NOW DO

  Medical Monitoring:
    ‚Üí Wife gets SMS if seizure detected
    ‚Üí Video evidence automatically captured
    ‚Üí Medical professional can review activity

  Security & Theft Prevention:
    ‚Üí Police/Insurance get email with video
    ‚Üí Timestamp and device info for reports
    ‚Üí Can prove who was there and when

  Emergency Response:
    ‚Üí One-click SOS button anytime
    ‚Üí Immediate alert to contacts
    ‚Üí Latest video evidence attached

  Motion Recording & Review:
    ‚Üí All events recorded locally
    ‚Üí View on dashboard with download button
    ‚Üí Auto-cleanup old files
    ‚Üí Optional cloud backup

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

EMERGENCY? DON'T JUST RELY ON ME_CAM:
  ‚ö†Ô∏è  Keep backup emergency plan (medical alert device, 911)
  ‚ö†Ô∏è  Test alerts regularly (monthly SOS button test)
  ‚ö†Ô∏è  Monitor logs periodically
  ‚ö†Ô∏è  Verify wife receives SMS messages
  ‚ö†Ô∏è  Have alternative contact method if system fails

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Version: 2.0 (Emergency Features & Advanced Recording)
Status: ‚úÖ Production Ready
Last Updated: January 13, 2026
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

