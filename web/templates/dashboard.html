<!doctype html>
<html>

<head>
    <title>ME Camera Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="navbar">
        <div class="brand">üìπ ME Camera</div>
        <a href="/">Dashboard</a>
        <a href="/config">‚öôÔ∏è Settings</a>
        <a href="/logout">Logout</a>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="dashboard-header">
            <div>
                <h1>Dashboard</h1>
                <div class="device-info">Device: <strong>{{ device_name or 'ME_CAM' }}</strong></div>
            </div>
            <div>
                {% if status.active %}
                <span class="status-pill online">‚óè ONLINE</span>
                {% else %}
                <span class="status-pill offline">‚óè OFFLINE</span>
                {% endif %}
                <span class="status-pill" style="margin-left:10px;">üîã {{ battery_percent }}%</span>
            </div>
        </div>

        <!-- Status Cards Grid -->
        <div class="status-grid">
            <div class="status-card">
                <div class="status-card-label">System Status</div>
                <div class="status-card-value">
                    {% if status.active %}
                    <span style="color: #81c784;">‚úì Active</span>
                    {% else %}
                    <span style="color: #ef5350;">‚úó Offline</span>
                    {% endif %}
                </div>
                <div class="status-card-subtext">Pipeline running</div>
            </div>

            <div class="status-card">
                <div class="status-card-label">Battery Level</div>
                {% if battery_percent is not none %}
                <div class="status-card-value">{{ battery_percent }}%</div>
                <div class="battery-bar {% if battery_low %}low{% endif %}">
                    <div class="battery-bar-fill" style="width: {{ battery_percent }}%"></div>
                </div>
                {% else %}
                <div class="status-card-value">External Power{% if battery_low %} (Low Voltage) {% endif %}</div>
                {% endif %}
                <div class="status-card-subtext">
                    {% if battery_low %}
                    <span style="color: #ef5350;">‚ö†Ô∏è Low voltage detected</span>
                    {% else %}
                    {% if battery_external %}Powered{% else %}Battery{% endif %}
                    {% endif %}
                </div>
            </div>

            <div class="status-card">
                <div class="status-card-label">Storage Used</div>
                <div class="status-card-value">{{ storage_used or '0.2' }} GB</div>
                <div class="battery-bar">
                    <div class="battery-bar-fill"
                        style="width: {{ (storage_used|float / 64 * 100)|int }}%; background: linear-gradient(90deg, #64b5f6, #2196f3);">
                    </div>
                </div>
                <div class="status-card-subtext">Retention: 7 days</div>
            </div>

            <div class="status-card">
                <div class="status-card-label">Recordings</div>
                <div class="status-card-value">{{ video_count or '0' }}</div>
                <div class="status-card-subtext">Recent motion clips</div>
            </div>
            <div class="status-card">
                <div class="status-card-label">History (24h)</div>
                <div class="status-card-value">{{ history_count or 0 }}</div>
                <div class="status-card-subtext">New events</div>
            </div>
        </div>

        <!-- Camera Section -->
        <div class="camera-section">
            <h2>üì∑ Cameras</h2>
            <div class="camera-grid">
                <div class="camera-card">
                    <div class="camera-feed active">
                        <!-- MJPEG stream display -->
                        <img id="liveStream" src="/api/stream"
                            style="width: 100%; height: 100%; object-fit: cover; display: block;"
                            onload="this.style.display='block';"
                            onerror="console.error('Stream failed'); setTimeout(() => { this.src='/api/stream?t=' + Date.now(); }, 2000);">
                    </div>
                    <div class="camera-info">
                        <div class="camera-name">{{ device_name or 'Main Camera' }}</div>
                        <div class="camera-timestamp">Live feed</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Emergency Alert Section -->
        <div class="alert-section">
            <h3>üö® Emergency Action</h3>
            <p>Send the latest motion detection to first responders.</p>
            <p style="font-size: 12px; color: #aaa;">
                Emergency Contact: <strong>{{ emergency_phone or 'Not configured' }}</strong>
            </p>
            <form method="post" action="/api/trigger_emergency" style="display: inline;">
                <button type="submit" class="btn-emergency" onclick="return confirm('Send emergency alert?')">
                    SEND TO FIRST RESPONDERS
                </button>
            </form>
        </div>

        <!-- Video Library -->
        <div class="video-library">
            <h2>üìπ Recordings & Storage</h2>

            <!-- Storage Summary -->
            <div class="storage-summary"
                style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #2196F3;" id="used-gb">-</div>
                        <div style="font-size: 12px; color: #666;">Used</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #4CAF50;" id="available-gb">-</div>
                        <div style="font-size: 12px; color: #666;">Available</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #FF9800;" id="total-gb">-</div>
                        <div style="font-size: 12px; color: #666;">Total</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #9C27B0;" id="file-count">-</div>
                        <div style="font-size: 12px; color: #666;">Files</div>
                    </div>
                </div>
                <div style="width: 100%; height: 8px; background: #ddd; border-radius: 4px; overflow: hidden;">
                    <div id="storage-bar"
                        style="height: 100%; width: 0%; background: linear-gradient(90deg, #2196F3, #FF9800); transition: width 0.3s;">
                    </div>
                </div>
            </div>

            <!-- Recordings Table -->
            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0;">All Files</h3>
                    <button onclick="refreshRecordings()"
                        style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">üîÑ
                        Refresh</button>
                </div>
                <div id="recordings-container"
                    style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; background: white;">
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <p>Loading recordings...</p>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions -->
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="clearAllRecordings()"
                    style="padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; flex: 1;">
                    üóëÔ∏è Clear All Recordings
                </button>
            </div>
        </div>

        <script>
            // Load recordings and storage info on page load
            window.addEventListener('load', function () {
                refreshRecordings();
            });

            function refreshRecordings() {
                // Load storage info
                fetch('/api/storage')
                    .then(r => r.json())
                    .then(data => {
                        if (data.ok) {
                            document.getElementById('used-gb').textContent = data.used_gb.toFixed(2);
                            document.getElementById('available-gb').textContent = data.available_gb.toFixed(2);
                            document.getElementById('total-gb').textContent = data.total_gb.toFixed(2);
                            document.getElementById('file-count').textContent = data.file_count;

                            // Update storage bar
                            let percent = data.total_gb > 0 ? (data.used_gb / data.total_gb) * 100 : 0;
                            document.getElementById('storage-bar').style.width = percent + '%';
                        }
                    })
                    .catch(e => console.error('Storage error:', e));

                // Load recordings
                fetch('/api/recordings')
                    .then(r => r.json())
                    .then(data => {
                        if (data.ok && data.recordings) {
                            let html = '';

                            if (data.recordings.length === 0) {
                                html = '<div style="text-align: center; padding: 40px; color: #999;"><p>üì≠ No recordings saved yet</p></div>';
                            } else {
                                html = '<table style="width: 100%; border-collapse: collapse;">';
                                html += '<tr style="background: #f0f0f0; font-weight: bold;">';
                                html += '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Filename</th>';
                                html += '<th style="padding: 12px; text-align: right; border-bottom: 1px solid #ddd; width: 100px;">Size (MB)</th>';
                                html += '<th style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd; width: 150px;">Date</th>';
                                html += '<th style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd; width: 150px;">Actions</th>';
                                html += '</tr>';

                                data.recordings.forEach(rec => {
                                    html += '<tr style="border-bottom: 1px solid #eee; hover: background: #f9f9f9;">';
                                    html += '<td style="padding: 12px; text-align: left;">' + escapeHtml(rec.name) + '</td>';
                                    html += '<td style="padding: 12px; text-align: right;">' + rec.size_mb.toFixed(2) + '</td>';
                                    html += '<td style="padding: 12px; text-align: center; font-size: 12px;">' + rec.date + '</td>';
                                    html += '<td style="padding: 12px; text-align: center;">';
                                    html += '<a href="' + rec.download_url + '" style="display: inline-block; margin-right: 8px; padding: 6px 12px; background: #4CAF50; color: white; text-decoration: none; border-radius: 4px; font-size: 12px; cursor: pointer;">‚¨áÔ∏è Download</a>';
                                    html += '<button onclick="deleteRecording(\'' + escapeHtml(rec.name) + '\')" style="display: inline-block; padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">üóëÔ∏è Delete</button>';
                                    html += '</td>';
                                    html += '</tr>';
                                });

                                html += '</table>';
                            }

                            document.getElementById('recordings-container').innerHTML = html;
                        }
                    })
                    .catch(e => {
                        document.getElementById('recordings-container').innerHTML = '<div style="text-align: center; padding: 40px; color: #f44336;">Error loading recordings</div>';
                        console.error('Recordings error:', e);
                    });
            }

            function deleteRecording(filename) {
                if (!confirm('Delete "' + filename + '"?')) return;

                fetch('/api/delete/' + encodeURIComponent(filename), { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.ok) {
                            refreshRecordings();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(e => {
                        alert('Delete failed: ' + e.message);
                        console.error('Delete error:', e);
                    });
            }

            function clearAllRecordings() {
                if (!confirm('Delete ALL recordings? This cannot be undone.')) return;

                fetch('/api/clear-storage', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.ok) {
                            alert('Deleted ' + data.deleted + ' files');
                            refreshRecordings();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(e => {
                        alert('Clear failed: ' + e.message);
                        console.error('Clear error:', e);
                    });
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        </script>

        <!-- Footer -->
        <div class="footer-links">
            <a href="/config">‚öôÔ∏è Configure</a>
            <a href="/multicam">üì° Multi-cam</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <script>
        setInterval(() => {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => console.log('Status:', data))
                .catch(e => console.error('Error:', e));
        }, 10000);
    </script>
</body>

</html>