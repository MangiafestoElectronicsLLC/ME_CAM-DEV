<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ username }} - Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="navbar">
        <div class="brand">ğŸ“¹ {{ device_name }}</div>
        <div class="nav-menu" style="display: flex; gap: 20px;">
            <a href="/dashboard">Dashboard</a>
            <a href="/multicam">ğŸ“¡ Devices</a>
            <a href="/config">âš™ï¸ Settings</a>
            <a href="/user/profile">ğŸ‘¤ Profile</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div>
                <h1>ğŸ  {{ username }}'s Security Hub</h1>
                <div class="device-info">Device: {{ device_name }} | User: {{ username }}</div>
            </div>
            <div class="header-right" style="display: flex; gap: 10px;">
                <span class="status-pill online" id="status-pill">â— ONLINE</span>
                <span class="status-pill" style="background: #0d47a1; color: #64b5f6;" id="battery-pill">ğŸ”‹ 100%</span>
            </div>
        </div>

        <!-- Status Grid -->
        <div class="status-grid">
            <div class="status-card">
                <h3>SYSTEM STATUS</h3>
                <div class="status-value">âœ“ Active</div>
                <div class="status-detail">Pipeline running</div>
            </div>

            <div class="status-card">
                <h3>BATTERY LEVEL</h3>
                <div class="status-value">{{ battery_percent if battery_percent else 'External Power' }}</div>
                <div class="status-bar">
                    <div class="status-bar-fill" style="width: {{ battery_percent if battery_percent else 100 }}%">
                    </div>
                </div>
                <div class="status-detail">
                    {% if battery_low %}<span style="color: #d32f2f;">âš ï¸ Low voltage</span>{% else %}Battery{% endif %}
                </div>
            </div>

            <div class="status-card">
                <h3>STORAGE USED</h3>
                <div class="status-value">{{ storage_used }} GB</div>
                <div class="status-bar">
                    <div class="status-bar-fill" style="width: {{ (storage_used / 100) * 100 }}%"></div>
                </div>
                <div class="status-detail">Retention: 7 days</div>
            </div>

            <div class="status-card">
                <h3>RECORDINGS</h3>
                <div class="status-value">{{ video_count }}</div>
                <div class="status-detail">Recent motion clips</div>
            </div>

            <div class="status-card">
                <h3>HISTORY (24H)</h3>
                <div class="status-value">{{ history_count }}</div>
                <div class="status-detail">New events</div>
            </div>
        </div>

        <!-- Camera Section -->
        <div class="camera-section">
            <h2>ğŸ“¹ Live Camera</h2>
            <div class="camera-feed"
                style="background: #000; border-radius: 8px; overflow: hidden; aspect-ratio: 16/9;">
                <img src="/api/stream" alt="Live MJPEG stream" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <h2>âš¡ Quick Actions</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <button
                    style="padding: 15px; background: #d32f2f; color: white; border: none; border-radius: 6px; cursor: pointer;"
                    onclick="triggerEmergency()">ğŸš¨ SOS Alert</button>
                <button
                    style="padding: 15px; background: #1976d2; color: white; border: none; border-radius: 6px; cursor: pointer;">ğŸ“¥
                    Download Recordings</button>
                <button
                    style="padding: 15px; background: #388e3c; color: white; border: none; border-radius: 6px; cursor: pointer;">ğŸ”„
                    Restart Camera</button>
            </div>
        </div>

        <!-- Recent Recordings -->
        <div class="video-library">
            <h2>ğŸ“¹ Recent Recordings</h2>
            {% if videos and videos|length > 0 %}
            <div class="video-grid">
                {% for video in videos %}
                <div class="video-item">
                    {% if video.thumb_url %}
                    <img src="{{ video.thumb_url }}" alt="{{ video.name }}" class="video-thumbnail">
                    {% else %}
                    <div class="video-thumbnail no-thumb">{{ video.name[:30] }}</div>
                    {% endif %}
                    <div class="video-info">{{ video.date }}</div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <p>No recordings yet. Motion detection will save clips here.</p>
            </div>
            {% endif %}
        </div>

        <!-- User Settings Card -->
        <div style="background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 20px; margin-top: 30px;">
            <h3 style="color: #2979ff;">ğŸ” User Settings</h3>
            <p style="color: #999;">Manage your account and security preferences</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <a href="/user/profile"
                    style="background: #2979ff; color: white; padding: 10px; border-radius: 6px; text-align: center; text-decoration: none; display: block;">ğŸ‘¤
                    Edit Profile</a>
                <a href="/user/change-password"
                    style="background: #1976d2; color: white; padding: 10px; border-radius: 6px; text-align: center; text-decoration: none; display: block;">ğŸ”‘
                    Change Password</a>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer-links">
            <a href="/config">âš™ï¸ Configure</a>
            <a href="/user/profile">ğŸ‘¤ Profile</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <script>
        function triggerEmergency() {
            if (confirm('Send emergency alert?')) {
                fetch('/api/trigger_emergency', { method: 'POST' })
                    .then(r => r.json())
                    .then(d => alert('Emergency alert sent!'))
                    .catch(e => alert('Error: ' + e));
            }
        }

        // Update all dashboard values dynamically
        function updateDashboard() {
            // Update status
            fetch('/api/status')
                .then(r => r.json())
                .then(d => {
                    const statusPill = document.querySelector('.status-pill.online') || document.querySelector('.status-pill.offline');
                    if (statusPill) {
                        if (d.active) {
                            statusPill.className = 'status-pill online';
                            statusPill.innerHTML = 'â— ONLINE';
                        } else {
                            statusPill.className = 'status-pill offline';
                            statusPill.innerHTML = 'â— OFFLINE';
                        }
                    }

                    // Update system status card
                    const statusValue = document.querySelector('.status-card .status-value');
                    if (statusValue && statusValue.textContent === 'âœ“ Active' || statusValue.textContent === 'âœ— Offline') {
                        statusValue.textContent = d.active ? 'âœ“ Active' : 'âœ— Offline';
                        statusValue.style.color = d.active ? '#4caf50' : '#d32f2f';
                    }
                })
                .catch(e => console.error('Status error:', e));

            // Update battery
            fetch('/api/battery')
                .then(r => r.json())
                .then(d => {
                    if (d.ok) {
                        // Update battery pill
                        const batteryPill = document.querySelector('.status-pill [style*="background: #0d47a1"]');
                        if (batteryPill) {
                            batteryPill.parentElement.innerHTML = `ğŸ”‹ ${d.percent}%`;
                        }

                        // Update battery card
                        const batteryCards = document.querySelectorAll('.status-card');
                        batteryCards.forEach(card => {
                            const title = card.querySelector('h3');
                            if (title && title.textContent === 'BATTERY LEVEL') {
                                const value = card.querySelector('.status-value');
                                const bar = card.querySelector('.status-bar-fill');
                                if (value) value.textContent = d.percent + '%';
                                if (bar) bar.style.width = d.percent + '%';
                            }
                        });
                    }
                })
                .catch(e => console.error('Battery error:', e));

            // Update storage
            fetch('/api/storage')
                .then(r => r.json())
                .then(d => {
                    if (d.ok) {
                        const storageCards = document.querySelectorAll('.status-card');
                        storageCards.forEach(card => {
                            const title = card.querySelector('h3');
                            if (title && title.textContent === 'STORAGE USED') {
                                const value = card.querySelector('.status-value');
                                const bar = card.querySelector('.status-bar-fill');
                                if (value) value.textContent = d.used_gb.toFixed(2) + ' GB';
                                if (bar) {
                                    const percent = d.total_gb > 0 ? (d.used_gb / d.total_gb) * 100 : 0;
                                    bar.style.width = percent + '%';
                                }
                            }
                        });
                    }
                })
                .catch(e => console.error('Storage error:', e));

            // Update recordings count
            fetch('/api/recordings')
                .then(r => r.json())
                .then(d => {
                    if (d.ok && d.recordings) {
                        const recordingsCards = document.querySelectorAll('.status-card');
                        recordingsCards.forEach(card => {
                            const title = card.querySelector('h3');
                            if (title && title.textContent === 'RECORDINGS') {
                                const value = card.querySelector('.status-value');
                                if (value) value.textContent = d.recordings.length;
                            }
                        });
                    }
                })
                .catch(e => console.error('Recordings error:', e));

            // Update history count
            fetch('/api/motion/events?hours=24&limit=1')
                .then(r => r.json())
                .then(d => {
                    if (d.ok) {
                        const historyCards = document.querySelectorAll('.status-card');
                        historyCards.forEach(card => {
                            const title = card.querySelector('h3');
                            if (title && title.textContent === 'HISTORY (24H)') {
                                const value = card.querySelector('.status-value');
                                if (value) value.textContent = d.count || 0;
                            }
                        });
                    }
                })
                .catch(e => console.error('History error:', e));
        }

        // Update on page load
        window.addEventListener('load', updateDashboard);

        // Update every 5 seconds
        setInterval(updateDashboard, 5000);
    </script>
</body>

</html>