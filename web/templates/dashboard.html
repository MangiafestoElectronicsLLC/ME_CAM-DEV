<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1f1f1f">
    <title>ME Camera Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Add mobile viewport configurations */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #2979ff;
                --success: #4caf50;
                --danger: #d32f2f;
                --warning: #ff9800;
                --bg-primary: #1f1f1f;
                --bg-secondary: #262626;
                --text-primary: #fff;
                --text-secondary: #ccc;
                --text-muted: #999;
                --border: #333;
            }
        }
    </style>
</head>

<body>
    <div class="navbar">
        <div class="brand">üìπ ME Camera</div>
        <div class="nav-menu" id="navMenu">
            <a href="/">Dashboard</a>
            <a href="/multicam">üì° Devices</a>
            <a href="/config">‚öôÔ∏è Settings</a>
            <a href="/logout">Logout</a>
        </div>
        <button class="nav-toggle" id="navToggle">‚ò∞</button>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-left">
                <h1>Dashboard</h1>
                <div class="device-info">
                    <span id="device-name">{{ device_name or 'ME_CAM_1' }}</span>
                    <span id="device-location" class="location-badge" style="display: none;"></span>
                </div>
            </div>
            <div class="header-right">
                {% if status.active %}
                <span class="status-pill online">‚óè ONLINE</span>
                {% else %}
                <span class="status-pill offline">‚óè OFFLINE</span>
                {% endif %}
                <span class="status-pill">üîã <span id="battery-display">{{ battery_percent }}%</span></span>
                <button class="btn-refresh" id="quickRefresh" title="Quick Refresh">‚ü≥</button>
            </div>
        </div>

        <!-- Quick Stats Bar (Mobile optimized) -->
        <div class="quick-stats">
            <div class="quick-stat">
                <span class="quick-stat-label">Uptime</span>
                <span class="quick-stat-value" id="uptime-display">--</span>
            </div>
            <div class="quick-stat">
                <span class="quick-stat-label">FPS</span>
                <span class="quick-stat-value" id="fps-display">0</span>
            </div>
            <div class="quick-stat">
                <span class="quick-stat-label">Latency</span>
                <span class="quick-stat-value" id="latency-display">--ms</span>
            </div>
            <div class="quick-stat">
                <span class="quick-stat-label">Network</span>
                <span class="quick-stat-value" id="signal-display">‚ö°</span>
            </div>
        </div>

        <!-- Status Cards Grid -->
        <div class="status-grid">
            <div class="status-card">
                <div class="status-card-label">System Status</div>
                <div class="status-card-value">
                    {% if status.active %}
                    <span style="color: #81c784;">‚úì Active</span>
                    {% else %}
                    <span style="color: #ef5350;">‚úó Offline</span>
                    {% endif %}
                </div>
                <div class="status-card-subtext">Pipeline running</div>
            </div>

            <div class="status-card">
                <div class="status-card-label">Battery Level</div>
                {% if battery_percent is not none %}
                <div class="status-card-value">{{ battery_percent }}%</div>
                <div class="battery-bar {% if battery_low %}low{% endif %}">
                    <div class="battery-bar-fill" style="width: {{ battery_percent }}%"></div>
                </div>
                {% else %}
                <div class="status-card-value">External Power{% if battery_low %} (Low) {% endif %}</div>
                {% endif %}
                <div class="status-card-subtext">
                    {% if battery_low %}
                    <span style="color: #ef5350;">‚ö†Ô∏è Low voltage</span>
                    {% else %}
                    {% if battery_external %}Powered{% else %}Battery{% endif %}
                    {% endif %}
                </div>
            </div>

            <div class="status-card">
                <div class="status-card-label">Storage Used</div>
                <div class="status-card-value"><span id="storage-used">{{ storage_used or '0.2' }}</span> GB</div>
                <div class="battery-bar">
                    <div class="battery-bar-fill"
                        style="width: {{ (storage_used|float / 64 * 100)|int }}%; background: linear-gradient(90deg, #64b5f6, #2196f3);">
                    </div>
                </div>
                <div class="status-card-subtext">Retention: 7 days</div>
                <button onclick="openStorageTab()" class="btn-small" style="margin-top: 10px; width: 100%;">View
                    Details</button>
            </div>

            <div class="status-card">
                <div class="status-card-label">Recordings</div>
                <div class="status-card-value" id="video-count-display">{{ video_count or '0' }}</div>
                <div class="status-card-subtext">Recent motion clips</div>
                <button onclick="openRecordingsTab()" class="btn-small"
                    style="margin-top: 10px; width: 100%;">Browse</button>
            </div>
            <div class="status-card">
                <div class="status-card-label">24h Events</div>
                <div class="status-card-value" id="history-count-display">{{ history_count or 0 }}</div>
                <div class="status-card-subtext">New events</div>
                <button onclick="openMotionEventsTab()" class="btn-small" style="margin-top: 10px; width: 100%;">View
                    Log</button>
            </div>
            <div class="status-card">
                <div class="status-card-label">Recording Mode</div>
                <div class="status-card-value" id="record-mode-display">Auto</div>
                <div class="status-card-subtext">Motion-triggered</div>
            </div>
        </div>

        <!-- Camera Section with adaptive streaming -->
        <div class="camera-section">
            <div class="camera-header">
                <h2>üì∑ Live Camera Feed</h2>
                <div class="camera-controls">
                    <select id="qualitySelector" onchange="changeStreamQuality()"
                        style="padding: 6px 12px; background: #2979ff; border: none; color: white; border-radius: 6px; cursor: pointer; font-size: 12px;">
                        <option value="low">üìä Low (240p)</option>
                        <option value="standard" selected>üìä Standard (480p)</option>
                        <option value="high">üìä High (720p)</option>
                        <option value="ultra">üìä Ultra (1080p)</option>
                    </select>
                    <button class="btn-small" id="fullscreenBtn" title="Fullscreen">‚õ∂</button>
                    <button class="btn-small" id="pauseBtn" title="Pause Stream">‚è∏</button>
                    <button class="btn-small" id="captureBtn" title="Capture Screenshot">üì∏</button>
                </div>
            </div>
            <div class="camera-grid">
                <div class="camera-card">
                    <div class="camera-feed-container">
                        <div id="liveStreamContainer" class="camera-feed">
                            <img id="liveStream" src="/api/stream"
                                style="width: 100%; height: 100%; object-fit: cover; display: block;"
                                onload="onStreamLoad()" onerror="onStreamError();">
                            <div id="streamSpinner" class="spinner" style="display: none;"></div>
                        </div>
                        <div class="stream-info">
                            <span id="streamStatus" class="stream-status">üî¥ Live</span>
                            <span id="streamResolution" class="stream-res">--</span>
                        </div>
                    </div>
                    <div class="camera-info">
                        <div class="camera-name">{{ device_name or 'Main Camera' }}</div>
                        <div class="camera-timestamp">Live feed</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Emergency Alert Section -->
        <div class="alert-section">
            <h3>üö® Emergency Actions</h3>
            <p>Quick access to emergency features and alerts.</p>
            <div class="emergency-contacts">
                <p style="font-size: 12px; color: #aaa;">
                    Primary Contact: <strong id="emergency-contact">{{ emergency_phone or 'Not configured' }}</strong>
                </p>
            </div>
            <div class="emergency-buttons">
                <button type="button" class="btn-emergency" id="emergencyBtn"
                    onclick="return confirm('Send emergency alert?')">
                    üö® EMERGENCY
                </button>
                <button type="button" class="btn-warning" id="medicalBtn">
                    üè• Medical Alert
                </button>
                <button type="button" class="btn-danger" id="securityBtn">
                    üîí Security Alert
                </button>
            </div>
        </div>

        <!-- Video Library -->
        <div class="video-library">
            <h2>üìπ Recordings & Storage</h2>

            <!-- Storage Summary -->
            <div class="storage-summary">
                <div class="storage-stats">
                    <div class="storage-stat">
                        <div class="storage-stat-value" id="used-gb">-</div>
                        <div class="storage-stat-label">Used</div>
                    </div>
                    <div class="storage-stat">
                        <div class="storage-stat-value" id="available-gb">-</div>
                        <div class="storage-stat-label">Available</div>
                    </div>
                    <div class="storage-stat">
                        <div class="storage-stat-value" id="total-gb">-</div>
                        <div class="storage-stat-label">Total</div>
                    </div>
                    <div class="storage-stat">
                        <div class="storage-stat-value" id="file-count">-</div>
                        <div class="storage-stat-label">Files</div>
                    </div>
                </div>
                <div class="storage-bar-container">
                    <div class="storage-bar">
                        <div id="storage-bar" class="storage-bar-fill"></div>
                    </div>
                    <div class="storage-percentage" id="storage-percentage">0%</div>
                </div>
            </div>

            <!-- Recordings Table -->
            <div class="recordings-section">
                <div class="recordings-header">
                    <h3>Recent Files</h3>
                    <div class="recordings-actions">
                        <select id="filterSort" class="btn-filter">
                            <option value="date-desc">Newest First</option>
                            <option value="date-asc">Oldest First</option>
                            <option value="size-desc">Largest First</option>
                            <option value="size-asc">Smallest First</option>
                        </select>
                        <button onclick="refreshRecordings()" class="btn-action">üîÑ Refresh</button>
                    </div>
                </div>
                <div id="recordings-container" class="recordings-list">
                    <div class="empty-state">
                        <p>Loading recordings...</p>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions -->
            <div class="bulk-actions">
                <button onclick="archiveRecordings()" class="btn-info">üì¶ Archive</button>
                <button onclick="downloadRecordings()" class="btn-success">‚¨áÔ∏è Download All</button>
                <button onclick="clearAllRecordings()" class="btn-danger">üóëÔ∏è Clear All</button>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer-links">
            <a href="/config">‚öôÔ∏è Configure</a>
            <a href="/multicam">üì° Multi-cam</a>
            <a href="javascript:location.reload()">üîÑ Reload</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <script>
        // Helper function to get API base URL (works with domain or IP)
        function getApiBaseUrl() {
            const protocol = window.location.protocol; // http: or https:
            const hostname = window.location.hostname; // ME_CAM.com or IP
            const port = window.location.port ? ':' + window.location.port : '';
            return protocol + '//' + hostname + port;
        }

        // For cleaner code, set this once
        const API_BASE = getApiBaseUrl();

        // Enhanced dashboard with performance monitoring
        let frameCount = 0;
        let lastFrameTime = Date.now();
        let streamPaused = false;
        let streamStartTime = Date.now();

        // Mobile menu toggle
        document.getElementById('navToggle').addEventListener('click', function () {
            const menu = document.getElementById('navMenu');
            menu.classList.toggle('active');
        });

        // Stream control buttons
        document.getElementById('pauseBtn').addEventListener('click', function () {
            streamPaused = !streamPaused;
            const img = document.getElementById('liveStream');
            if (streamPaused) {
                img.src = '';
                this.textContent = '‚ñ∂Ô∏è';
                this.classList.add('paused');
            } else {
                img.src = '/api/stream?t=' + Date.now();
                this.textContent = '‚è∏';
                this.classList.remove('paused');
            }
        });

        document.getElementById('fullscreenBtn').addEventListener('click', function () {
            const container = document.getElementById('liveStreamContainer');
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => console.log('Fullscreen error:', err));
            } else {
                document.exitFullscreen();
            }
        });

        document.getElementById('captureBtn').addEventListener('click', function () {
            const canvas = document.createElement('canvas');
            const img = document.getElementById('liveStream');
            canvas.width = img.naturalWidth || img.width;
            canvas.height = img.naturalHeight || img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/jpeg');
            link.download = `capture-${Date.now()}.jpg`;
            link.click();
        });

        // Emergency button handlers
        document.getElementById('emergencyBtn').addEventListener('click', function () {
            triggerEmergency('general');
        });

        document.getElementById('medicalBtn').addEventListener('click', function () {
            if (confirm('Send medical emergency alert?')) {
                triggerEmergency('medical');
            }
        });

        document.getElementById('securityBtn').addEventListener('click', function () {
            if (confirm('Send security emergency alert?')) {
                triggerEmergency('security');
            }
        });

        // Stream load/error handlers
        function onStreamLoad() {
            document.getElementById('streamStatus').textContent = 'üü¢ Live';
            frameCount++;
            updateFPS();
        }

        function onStreamError() {
            document.getElementById('streamStatus').textContent = 'üî¥ Buffering';
            setTimeout(() => {
                if (!streamPaused) {
                    document.getElementById('liveStream').src = '/api/stream?t=' + Date.now();
                }
            }, 2000);
        }

        // FPS and performance monitoring
        function updateFPS() {
            const now = Date.now();
            const elapsed = now - lastFrameTime;
            if (elapsed >= 1000) {
                const fps = Math.round((frameCount * 1000) / elapsed);
                document.getElementById('fps-display').textContent = fps;
                frameCount = 0;
                lastFrameTime = now;
            }
        }

        // Uptime display
        function updateUptime() {
            const uptime = Math.floor((Date.now() - streamStartTime) / 1000);
            const hours = Math.floor(uptime / 3600);
            const mins = Math.floor((uptime % 3600) / 60);
            document.getElementById('uptime-display').textContent = `${hours}h ${mins}m`;
        }

        // Quick refresh
        document.getElementById('quickRefresh').addEventListener('click', function () {
            refreshRecordings();
            updateSystemStatus();
            this.classList.add('spinning');
            setTimeout(() => this.classList.remove('spinning'), 500);
        });

        // Load recordings and storage info on page load
        window.addEventListener('load', function () {
            refreshRecordings();
            updateSystemStatus();
            setInterval(updateUptime, 60000);
            updateUptime();
        });

        // Sort/filter recordings
        document.getElementById('filterSort').addEventListener('change', function () {
            refreshRecordings(this.value);
        });

        function updateSystemStatus() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    if (data && data.active !== undefined) {
                        const online = data.active;
                        document.getElementById('streamStatus').textContent = online ? 'üü¢ Live' : 'üî¥ Offline';
                    }
                })
                .catch(e => console.error('Status update error:', e));
        }

        function refreshRecordings(sortBy = 'date-desc') {
            // Load storage info
            fetch('/api/storage')
                .then(r => r.json())
                .then(data => {
                    if (data.ok) {
                        document.getElementById('used-gb').textContent = data.used_gb.toFixed(2);
                        document.getElementById('available-gb').textContent = data.available_gb.toFixed(2);
                        document.getElementById('total-gb').textContent = data.total_gb.toFixed(2);
                        document.getElementById('file-count').textContent = data.file_count;
                        document.getElementById('storage-used').textContent = data.used_gb.toFixed(2);

                        // Update storage bar
                        let percent = data.total_gb > 0 ? (data.used_gb / data.total_gb) * 100 : 0;
                        document.getElementById('storage-bar').style.width = percent + '%';
                        document.getElementById('storage-percentage').textContent = Math.round(percent) + '%';
                    }
                })
                .catch(e => console.error('Storage error:', e));

            // Load recordings
            fetch('/api/recordings')
                .then(r => r.json())
                .then(data => {
                    if (data.ok && data.recordings) {
                        let recordings = data.recordings || [];

                        // Sort recordings
                        switch (sortBy) {
                            case 'date-asc':
                                recordings.sort((a, b) => a.timestamp - b.timestamp);
                                break;
                            case 'size-desc':
                                recordings.sort((a, b) => b.size_mb - a.size_mb);
                                break;
                            case 'size-asc':
                                recordings.sort((a, b) => a.size_mb - b.size_mb);
                                break;
                            default: // date-desc
                                recordings.sort((a, b) => b.timestamp - a.timestamp);
                        }

                        let html = '';

                        if (recordings.length === 0) {
                            html = '<div class="empty-state"><p>üì≠ No recordings saved yet</p></div>';
                        } else {
                            html = '<div class="recordings-table">';
                            recordings.forEach((rec, idx) => {
                                const isLarge = rec.size_mb > 50;
                                html += '<div class="recording-item ' + (isLarge ? 'large' : '') + '">';
                                html += '<div class="recording-info">';
                                html += '<div class="recording-name">' + escapeHtml(rec.name) + '</div>';
                                html += '<div class="recording-meta">';
                                html += '<span>' + rec.size_mb.toFixed(2) + ' MB</span>';
                                html += '<span>‚Ä¢</span>';
                                html += '<span>' + rec.date + '</span>';
                                html += '</div>';
                                html += '</div>';
                                html += '<div class="recording-actions">';
                                html += '<a href="/api/download/' + encodeURIComponent(rec.name) + '" class="btn-mini" title="Download">‚¨áÔ∏è</a>';
                                html += '<button onclick="deleteRecording(\'' + escapeHtml(rec.name) + '\')" class="btn-mini btn-danger" title="Delete">üóëÔ∏è</button>';
                                html += '</div>';
                                html += '</div>';
                            });
                            html += '</div>';
                        }

                        document.getElementById('recordings-container').innerHTML = html;
                    }
                })
                .catch(e => {
                    document.getElementById('recordings-container').innerHTML = '<div class="empty-state" style="color: #f44336;">Error loading recordings</div>';
                    console.error('Recordings error:', e);
                });
        }

        function triggerEmergency(type) {
            fetch('/api/trigger_emergency', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: type })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.ok) {
                        alert('‚úì ' + data.message);
                    } else {
                        alert('‚úó Error: ' + data.error);
                    }
                })
                .catch(e => {
                    alert('Error sending alert: ' + e.message);
                    console.error('Emergency error:', e);
                });
        }

        function deleteRecording(filename) {
            if (!confirm('Delete "' + filename + '"?')) return;

            fetch('/api/delete/' + encodeURIComponent(filename), { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.ok) {
                        refreshRecordings();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(e => {
                    alert('Delete failed: ' + e.message);
                    console.error('Delete error:', e);
                });
        }

        function clearAllRecordings() {
            if (!confirm('Delete ALL recordings? This cannot be undone.')) return;

            fetch('/api/clear-storage', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.ok) {
                        alert('Deleted ' + data.deleted + ' files');
                        refreshRecordings();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(e => {
                    alert('Clear failed: ' + e.message);
        <!-- Motion Events Modal -->
        <div id="motionEventsModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>üìä Motion Activity Log</h2>
                    <button class="modal-close" onclick="closeMotionEventsModal()">&times;</button>
                </div>
                <div id="motionEventsList" class="modal-body">
                    <p>Loading motion events...</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="exportMotionEvents()">üì• Export CSV</button>
                    <button class="btn-secondary" onclick="closeMotionEventsModal()">Close</button>
                </div>
            </div>
        </div>

        <!--Storage Details Modal-- >
        <div id="storageModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>üíæ Storage Details</h2>
                    <button class="modal-close" onclick="closeStorageModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="storageDetails" style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 15px; background: #2a2a2a; border-radius: 8px;">
                                <div style="font-size: 12px; color: #999;">Used</div>
                                <div style="font-size: 24px; color: #2196f3; font-weight: bold;" id="detail-used-gb">-- GB</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #2a2a2a; border-radius: 8px;">
                                <div style="font-size: 12px; color: #999;">Available</div>
                                <div style="font-size: 24px; color: #4caf50; font-weight: bold;" id="detail-available-gb">-- GB</div>
                            </div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #2a2a2a; border-radius: 8px; margin-bottom: 20px;">
                            <div style="font-size: 12px; color: #999;">Total</div>
                            <div style="font-size: 24px; color: #ff9800; font-weight: bold;" id="detail-total-gb">-- GB</div>
                        </div>
                        <div style="margin: 20px 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 12px;">Storage Usage</span>
                                <span style="font-size: 12px;" id="detail-usage-percent">0%</span>
                            </div>
                            <div style="width: 100%; height: 20px; background: #333; border-radius: 10px; overflow: hidden;">
                                <div id="detail-storage-bar" style="height: 100%; background: linear-gradient(90deg, #2196f3, #1976d2); width: 0%;"></div>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #999; padding: 10px; background: #2a2a2a; border-radius: 8px;">
                            <span id="detail-file-count">0</span> files stored
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-danger" onclick="clearAllRecordings()" style="margin-right: auto;">üóëÔ∏è Clear All</button>
                    <button class="btn-secondary" onclick="closeStorageModal()">Close</button>
                </div>
            </div>
        </div>

        <!--Recordings Modal-- >
        <div id="recordingsModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>üìπ Recordings</h2>
                    <button class="modal-close" onclick="closeRecordingsModal()">&times;</button>
                </div>
                <div id="recordingsList" class="modal-body">
                    <p>Loading recordings...</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeRecordingsModal()">Close</button>
                </div>
            </div>
        </div>

        <!--Footer -->
                        <div class="footer-links">
                            <a href="/config">‚öôÔ∏è Configure</a>
                            <a href="/multicam">üì° Multi-cam</a>
                            <a href="javascript:location.reload()">üîÑ Reload</a>
                            <a href="/logout">Logout</a>
                        </div>
    </div >

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
        }

        .modal-content {
            background-color: #1f1f1f;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #333;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #999;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #fff;
        }

        .modal-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #333;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .motion-event-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #2a2a2a;
            border-left: 3px solid #2196f3;
            border-radius: 4px;
            font-size: 13px;
        }

        .motion-event-item.person {
            border-left-color: #ff9800;
        }

        .motion-event-item.security {
            border-left-color: #f44336;
        }

        .motion-event-time {
            color: #999;
            font-size: 11px;
        }

        .motion-event-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 8px;
        }

        .motion-event-type.motion {
            background: #2196f3;
            color: white;
        }

        .motion-event-type.person {
            background: #ff9800;
            color: white;
        }

        .motion-event-type.security {
            background: #f44336;
            color: white;
        }

        .recording-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #2a2a2a;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recording-info {
            flex: 1;
        }

        .recording-name {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .recording-meta {
            font-size: 11px;
            color: #999;
        }

        .recording-actions {
            display: flex;
            gap: 8px;
        }

        .btn-mini {
            padding: 6px 12px;
            background: #2979ff;
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-mini:hover {
            background: #1e5db8;
        }

        .btn-mini.btn-danger {
            background: #f44336;
        }

        .btn-mini.btn-danger:hover {
            background: #d32f2f;
        }
    </style>

    <script>
        // Tab functions
        function openMotionEventsTab() {
            document.getElementById('motionEventsModal').style.display = 'block';
            loadMotionEvents();
        }

        function closeMotionEventsModal() {
            document.getElementById('motionEventsModal').style.display = 'none';
        }

        function openStorageTab() {
            document.getElementById('storageModal').style.display = 'block';
            loadStorageDetails();
        }

        function closeStorageModal() {
            document.getElementById('storageModal').style.display = 'none';
        }

        function openRecordingsTab() {
            document.getElementById('recordingsModal').style.display = 'block';
            loadRecordingsList();
        }

        function closeRecordingsModal() {
            document.getElementById('recordingsModal').style.display = 'none';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            let motionModal = document.getElementById('motionEventsModal');
            let storageModal = document.getElementById('storageModal');
            let recordingsModal = document.getElementById('recordingsModal');
            
            if (event.target == motionModal) motionModal.style.display = 'none';
            if (event.target == storageModal) storageModal.style.display = 'none';
            if (event.target == recordingsModal) recordingsModal.style.display = 'none';
        }

        function loadMotionEvents() {
            fetch('/api/motion/events?hours=24&limit=50')
                .then(r => r.json())
                .then(data => {
                    if (data.ok && data.events) {
                        let html = '';
                        if (data.events.length === 0) {
                            html = '<p style="text-align: center; color: #999;">No motion events in the last 24 hours</p>';
                        } else {
                            data.events.forEach(event => {
                                const date = new Date(event.timestamp);
                                const timeStr = date.toLocaleString();
                                const confPercent = (event.confidence * 100).toFixed(1);
                                html += `<div class="motion-event-item ${event.type}">
                                    <div style="margin-bottom: 4px;">
                                        <span class="motion-event-type ${event.type}">${event.type.toUpperCase()}</span>
                                        <span style="color: #ccc;">${confPercent}% confidence</span>
                                    </div>
                                    <div class="motion-event-time">${timeStr}</div>
                                </div>`;
                            });
                        }
                        document.getElementById('motionEventsList').innerHTML = html;
                        document.getElementById('history-count-display').textContent = data.count;
                    }
                })
                .catch(e => {
                    document.getElementById('motionEventsList').innerHTML = '<p style="color: #f44336;">Error loading motion events</p>';
                    console.error('Motion events error:', e);
                });
        }

        function loadStorageDetails() {
            fetch('/api/storage')
                .then(r => r.json())
                .then(data => {
                    if (data.ok) {
                        document.getElementById('detail-used-gb').textContent = data.used_gb.toFixed(2) + ' GB';
                        document.getElementById('detail-available-gb').textContent = data.available_gb.toFixed(2) + ' GB';
                        document.getElementById('detail-total-gb').textContent = data.total_gb.toFixed(2) + ' GB';
                        document.getElementById('detail-file-count').textContent = data.file_count;
                        
                        let percent = data.total_gb > 0 ? (data.used_gb / data.total_gb) * 100 : 0;
                        document.getElementById('detail-storage-bar').style.width = percent + '%';
                        document.getElementById('detail-usage-percent').textContent = Math.round(percent) + '%';
                    }
                })
                .catch(e => {
                    console.error('Storage error:', e);
                });
        }

        function loadRecordingsList() {
            fetch('/api/recordings')
                .then(r => r.json())
                .then(data => {
                    if (data.ok && data.recordings) {
                        let html = '';
                        if (data.recordings.length === 0) {
                            html = '<p style="text-align: center; color: #999;">No recordings saved yet</p>';
                        } else {
                            data.recordings.forEach(rec => {
                                html += `<div class="recording-item">
                                    <div class="recording-info">
                                        <div class="recording-name">${escapeHtml(rec.name)}</div>
                                        <div class="recording-meta">${rec.size_mb.toFixed(2)} MB ‚Ä¢ ${rec.date}</div>
                                    </div>
                                    <div class="recording-actions">
                                        <a href="/api/download/${encodeURIComponent(rec.name)}" class="btn-mini">‚¨áÔ∏è</a>
                                        <button onclick="deleteRecording('${escapeHtml(rec.name)}')" class="btn-mini btn-danger">üóëÔ∏è</button>
                                    </div>
                                </div>`;
                            });
                        }
                        document.getElementById('recordingsList').innerHTML = html;
                    }
                })
                .catch(e => {
                    document.getElementById('recordingsList').innerHTML = '<p style="color: #f44336;">Error loading recordings</p>';
                    console.error('Recordings error:', e);
                });
        }

        function exportMotionEvents() {
            window.location.href = '/api/motion/export?hours=24';
            alert('‚úì Motion events exported as CSV');
        }

        function changeStreamQuality() {
            const quality = document.getElementById('qualitySelector').value;
            
            fetch('/api/stream/quality', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({quality: quality})
            })
                .then(r => r.json())
                .then(data => {
                    if (data.ok) {
                        // Restart stream with new quality
                        const img = document.getElementById('liveStream');
                        img.src = '/api/stream?t=' + Date.now();
                        console.log('‚úì Stream quality changed to:', quality);
                    } else {
                        alert('Error changing quality: ' + data.error);
                    }
                })
                .catch(e => {
                    alert('Error: ' + e.message);
                    console.error('Quality change error:', e);
                });
        }