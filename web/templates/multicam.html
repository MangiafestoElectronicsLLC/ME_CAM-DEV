<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi-Device Management - ME Camera</title>
  <link rel="stylesheet" href="/static/style.css">
</head>

<body>
  <div class="navbar">
    <div class="brand">üìπ ME Camera</div>
    <div class="nav-menu" id="navMenu">
      <a href="/">Dashboard</a>
      <a href="/multicam">üì° Devices</a>
      <a href="/config">‚öôÔ∏è Settings</a>
      <a href="/logout">Logout</a>
    </div>
    <button class="nav-toggle" id="navToggle">‚ò∞</button>
  </div>

  <div class="container">
    <!-- Header -->
    <div class="dashboard-header">
      <div class="header-left">
        <h1>Multi-Device Management</h1>
        <div class="device-info">Manage multiple cameras and devices</div>
      </div>
      <div class="header-right">
        <button class="btn-small" id="addDeviceBtn">‚ûï Add Device</button>
        <button class="btn-small" onclick="location.reload()">‚ü≥ Refresh</button>
      </div>
    </div>

    <!-- Device Stats -->
    <div class="status-grid">
      <div class="status-card">
        <div class="status-card-label">Connected Devices</div>
        <div class="status-card-value" id="device-count">{{ devices|length }}</div>
        <div class="status-card-subtext">Active cameras</div>
      </div>
      <div class="status-card">
        <div class="status-card-label">Total Storage</div>
        <div class="status-card-value" id="total-storage">-- GB</div>
        <div class="status-card-subtext">Across all devices</div>
      </div>
      <div class="status-card">
        <div class="status-card-label">Events (24h)</div>
        <div class="status-card-value" id="total-events">0</div>
        <div class="status-card-subtext">All devices combined</div>
      </div>
      <div class="status-card">
        <div class="status-card-label">Avg Battery</div>
        <div class="status-card-value" id="avg-battery">--</div>
        <div class="status-card-subtext">Across batteries</div>
      </div>
    </div>

    <!-- Devices Grid -->
    <div style="margin: 30px 0;">
      <h2 style="margin-bottom: 20px;">üìπ Your Devices</h2>
      <div class="devices-grid">
        {% if devices %}
        {% for dev in devices %}
        <div class="device-card" onclick="openDeviceDetails('{{ dev.id or dev.name }}')">
          <div class="device-card-header">
            <div class="device-card-title">{{ dev.name or 'Camera' }}</div>
            <div class="device-card-status">
              <span class="status-dot"></span>
              <span>Online</span>
            </div>
          </div>
          <div class="device-card-body">
            <div class="device-info-row">
              <span class="device-info-label">üìç Location:</span>
              <span class="device-info-value">{{ dev.location or 'Not set' }}</span>
            </div>
            <div class="device-info-row">
              <span class="device-info-label">üîã Battery:</span>
              <span class="device-info-value">75%</span>
            </div>
            <div class="device-info-row">
              <span class="device-info-label">üíæ Storage:</span>
              <span class="device-info-value">12.5 GB</span>
            </div>
            <div class="device-info-row">
              <span class="device-info-label">‚è±Ô∏è Last Seen:</span>
              <span class="device-info-value">Just now</span>
            </div>
          </div>
          <div class="device-card-footer">
            <button onclick="event.stopPropagation(); openDevice('{{ dev.url or '/' }}')">üé• View</button>
            <button onclick="event.stopPropagation(); editDevice('{{ dev.id or dev.name }}')">‚úèÔ∏è Edit</button>
          </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state" style="grid-column: 1/-1;">
          <p>No devices configured yet.</p>
          <p style="font-size: 12px; margin-top: 10px; color: #666;">
            Add a device to start monitoring your cameras.
          </p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Add Device Modal -->
    <div id="addDeviceModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Add New Device</h2>
          <button class="modal-close" onclick="closeAddDeviceModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('manual')">‚úèÔ∏è Manual Entry</button>
          </div>

          <!-- Manual Entry Tab -->
          <div id="manualTab" class="tab-content active">
            <div class="form-group">
              <label>Device ID / IP Address</label>
              <input type="text" id="deviceId" placeholder="192.168.1.100 or device-id" class="form-input">
            </div>
            <div class="form-group">
              <label>Device Name</label>
              <input type="text" id="deviceName" placeholder="Front Door Camera" class="form-input">
            </div>
            <div class="form-group">
              <label>Location</label>
              <input type="text" id="deviceLocation" placeholder="Front Porch" class="form-input">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" onclick="closeAddDeviceModal()">Cancel</button>
          <button class="btn-primary" onclick="saveDevice()">Add Device</button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer-links">
      <a href="/">‚Üê Back to Dashboard</a>
      <a href="/config">‚öôÔ∏è Settings</a>
      <a href="/logout">Logout</a>
    </div>
  </div>

  <style>
    .devices-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .device-card {
      background: linear-gradient(135deg, #1f1f1f 0%, #262626 100%);
      border: 2px solid #333;
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s;
      cursor: pointer;
      display: flex;
      flex-direction: column;
    }

    .device-card:hover {
      border-color: #2979ff;
      box-shadow: 0 8px 24px rgba(41, 121, 255, 0.3);
      transform: translateY(-4px);
    }

    .device-card-header {
      background: linear-gradient(135deg, #2979ff, #1e5db8);
      padding: 20px;
      color: white;
    }

    .device-card-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .device-card-status {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4caf50;
    }

    .device-card-body {
      padding: 15px;
      flex: 1;
    }

    .device-info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 12px 0;
      font-size: 13px;
    }

    .device-info-label {
      color: #999;
    }

    .device-info-value {
      color: #fff;
      font-weight: bold;
    }

    .device-card-footer {
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      gap: 8px;
      border-top: 1px solid #333;
    }

    .device-card-footer button {
      flex: 1;
      padding: 8px;
      font-size: 12px;
      border: 1px solid #333;
      border-radius: 6px;
      background: transparent;
      color: #2979ff;
      cursor: pointer;
      transition: all 0.3s;
    }

    .device-card-footer button:hover {
      background: rgba(41, 121, 255, 0.1);
      border-color: #2979ff;
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal-content {
      background: #1f1f1f;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid #333;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #333;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
    }

    .modal-close {
      background: none;
      border: none;
      color: #999;
      font-size: 28px;
      cursor: pointer;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      display: flex;
      gap: 10px;
      padding: 20px;
      border-top: 1px solid #333;
    }

    .modal-footer button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-primary {
      background: #2979ff;
      color: white;
    }

    .btn-secondary {
      background: #333;
      color: #ccc;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid #333;
    }

    .tab-btn {
      background: none;
      border: none;
      color: #999;
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }

    .tab-btn.active {
      color: #2979ff;
      border-bottom-color: #2979ff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 13px;
      color: #ccc;
    }

    .form-input {
      width: 100%;
      padding: 10px;
      background: #262626;
      border: 1px solid #444;
      border-radius: 6px;
      color: #fff;
    }

    @media (max-width: 768px) {
      .devices-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <script>
    // Mobile menu toggle
    document.getElementById('navToggle').addEventListener('click', function () {
      const menu = document.getElementById('navMenu');
      menu.classList.toggle('active');
    });

    document.getElementById('addDeviceBtn').addEventListener('click', function () {
      document.getElementById('addDeviceModal').style.display = 'flex';
    });

    function closeAddDeviceModal() {
      document.getElementById('addDeviceModal').style.display = 'none';
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

      const tabElement = document.getElementById(tab + 'Tab');
      const buttons = document.querySelectorAll('.tab-btn');
      const btnIndex = tab === 'qr' ? 0 : 1;

      if (tabElement) tabElement.classList.add('active');
      if (buttons[btnIndex]) buttons[btnIndex].classList.add('active');
    }

    function saveDevice() {
      const deviceId = document.getElementById('deviceId').value.trim();
      const deviceName = document.getElementById('deviceName').value.trim();
      const deviceLocation = document.getElementById('deviceLocation').value.trim();

      if (!deviceId) {
        alert('Please enter a device ID or IP address');
        return;
      }

      // POST to API
      fetch('/api/devices', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: deviceId,
          name: deviceName || 'Camera',
          location: deviceLocation
        })
      })
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            alert('Device added successfully!');
            location.reload();
          } else {
            alert('Error: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(e => {
          alert('Error adding device: ' + e.message);
          console.error(e);
        });

      closeAddDeviceModal();
    }

    function openDevice(url) {
      if (url && url !== '/') {
        window.location.href = url;
      } else {
        window.location.href = '/';
      }
    }

    function editDevice(id) {
      alert('Edit feature coming soon!');
    }

    function openDeviceDetails(id) {
      // Load device details from API
      fetch('/api/devices')
        .then(r => r.json())
        .then(data => {
          if (data.ok && data.devices) {
            const device = data.devices.find(d => d.id === id || d.name === id);
            if (device) {
              alert(`Device: ${device.name}\nStatus: ${device.status}\nBattery: ${device.battery}%\nStorage: ${device.storage}`);
            }
          }
        })
        .catch(e => console.error('Error loading device details:', e));
    }

    // Load device list on page load
    function loadDevices() {
      fetch('/api/devices')
        .then(r => r.json())
        .then(data => {
          if (data.ok && data.devices) {
            updateDeviceStats(data.devices);
          }
        })
        .catch(e => console.error('Error loading devices:', e));
    }

    function updateDeviceStats(devices) {
      let totalStorage = 0;
      let totalEvents = 0;
      let totalBattery = 0;
      let deviceCount = devices.length;

      devices.forEach(device => {
        // Parse storage value (format: "X.XX GB")
        const storageMatch = device.storage ? device.storage.match(/[\d.]+/) : null;
        if (storageMatch) totalStorage += parseFloat(storageMatch[0]);

        // Add events
        totalEvents += device.events_24h || 0;

        // Add battery percentage
        totalBattery += device.battery || 0;
      });

      document.getElementById('device-count').textContent = deviceCount;
      document.getElementById('total-storage').textContent = totalStorage.toFixed(2) + ' GB';
      document.getElementById('total-events').textContent = totalEvents;
      document.getElementById('avg-battery').textContent = deviceCount > 0 ? Math.round(totalBattery / deviceCount) + '%' : '--';
    }

    window.addEventListener('load', loadDevices);
    setInterval(loadDevices, 30000); // Refresh every 30 seconds

    window.addEventListener('click', function (event) {
      const modal = document.getElementById('addDeviceModal');
      if (event.target === modal) {
        closeAddDeviceModal();
      }
    });
  </script>
</body>

</html>